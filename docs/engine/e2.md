# E2 – Data & Storage Model

**Status:** 95% Complete - January 21, 2026

**Completed:**
- ✅ E2.1-E2.2: Driver contracts and snapshot providers
- ✅ E2.3: 11/11 handler families implemented (240/240 tests)
- ✅ E2.4: Room mutation writers and memory persistence
- ✅ E2.5: Test coverage and parity checks

**Blocked by E5 (4 features):**
- PWR_GENERATE_OPS power ability (needs global power balance)
- User power balance tracking in PowerSpawn
- User GCL updates in Controller
- Boost effects GCL component in Controller

See `e5.md` for E5 blocker details and implementation plan.

---

## Completed Handlers ✅

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ✅ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ✅ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ✅ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ✅ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ✅ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ✅ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ✅
- ✅ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (31/31 tests, lab capacity tracking, power effects)

### Core Controller Actions ✅
- ✅ **Controller** - `ControllerIntentStep` (12/12 tests, upgrade, reserve, attack with level transitions)
  - ✅ SafeMode available tracking (parity-critical)
  - ⚠️ Boost effects - Progress calculation complete, GCL updates blocked by E5

### Lab Reactions & Boosts ✅
- ✅ **Lab Reactions & Boosts** - `LabIntentStep` (27/27 tests, runReaction with 62 formulas, boostCreep with 40 boost types, unboostCreep with mineral returns, cooldown tracking, capacity management, action log recording, PWR_OPERATE_LAB effect support)

### Structure Energy Routing ✅
- ✅ **Link Energy Transfer** - `LinkIntentStep` (8/8 tests, energy transfers between links with 3% loss ratio, distance-based cooldowns, action log recording)
- ✅ **Power Spawn Processing** - `PowerSpawnIntentStep` (9/9 tests, consumes 1 power + 50 energy per tick to generate ops, PWR_OPERATE_POWER effect support)
- ✅ **Factory Production** - `FactoryIntentStep` (11/11 tests, commodity production with 62 recipes, multi-component consumption, level gating, cumulative cooldowns, action log recording, PWR_OPERATE_FACTORY effect support)

### Global/Power Creep Handlers
- ✅ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ✅ **Power Creep Abilities** - `PowerAbilityStep` (58/58 tests: 4 decay + 10 core + 32 effect-based + 12 direct-action)
  - ✅ Effect decay logic (`PowerEffectDecayStep`)
  - ✅ All 18 power abilities implemented (generateOps deferred to E5)
  - ⚠️ generateOps ability - Blocked by E5 (requires global power balance tracking)
- ✅ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ✅ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ✅ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ✅ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ✅ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ✅ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Deferred Features

### Parity-Critical (Blocked by E5)

These features require E5 (Global Systems) infrastructure. See `e5.md` for detailed E5 implementation plan.

#### 1. PWR_GENERATE_OPS Power Ability
**Handler:** `PowerAbilityStep.ProcessUsePower`
**Status:** ❌ Blocked by E5 global mutation infrastructure
**Parity:** ✅ Required for E7 validation

**What's needed:**
- E5 must implement `IGlobalMutationWriter.DecrementUserPower(userId, amount)`
- Add generateOps case to power ability switch statement
- Calculate ops amount: `powerInfo.Effect[level - 1]` (levels 1-5: 1/2/4/6/8 ops)
- Add ops to power creep store, drop overflow if exceeds capacity
- 2 tests: valid use (ops added), overflow (drops created)

**Effort after E5:** 1-2 hours

#### 2. User Power Balance Tracking (PowerSpawn)
**Handler:** `PowerSpawnIntentStep.ProcessPowerSpawn`
**Status:** ❌ Blocked by E5 global mutation infrastructure
**Parity:** ✅ Required for E7 validation

**What's needed:**
- E5 must implement `IGlobalMutationWriter.IncrementUserPower(userId, amount)`
- In `ProcessPowerSpawn`, call `context.GlobalMutationWriter.IncrementUserPower(powerSpawn.UserId, amount)`
- No new tests needed (existing tests cover power spawn processing)

**Effort after E5:** 30 minutes

#### 3. User GCL Updates (Controller)
**Handler:** `ControllerIntentStep.ProcessUpgrade`
**Status:** ❌ Blocked by E5 global mutation infrastructure
**Parity:** ✅ Required for E7 validation

**Node.js behavior:** Calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade

**What's needed:**
- E5 must implement `IGlobalMutationWriter.IncrementUserGcl(userId, amount)`
- In `ProcessUpgrade`, call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
- Applies to both non-boosted AND boosted upgrades
- `UserState` schema already has GCL field

**Effort after E5:** 1-2 hours (includes boost component below)

#### 4. Boost Effects GCL Component (Controller)
**Handler:** `ControllerIntentStep.ProcessUpgrade`
**Status:** ⚠️ **PARTIALLY IMPLEMENTED** - Controller progress calculation complete, GCL updates blocked
**Parity:** ✅ Required for E7 validation

**What's implemented:**
- ✅ Boost calculation helper (`CalculateBoostEffect`)
- ✅ Constants (`WorkBoostUpgradeMultipliers`: GH 1.5x, GH2O 1.8x, XGH2O 2.0x)
- ✅ 4 comprehensive tests covering boost mechanics

**What's missing:**
- ❌ GCL increment mutation (same as #3 above)
- In `ProcessUpgrade`, boosted GCL gains need to call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, boostedProgressGain)`

**Effort after E5:** Included in #3 (same code path)

### Non-Parity-Critical (Future Work)

These features don't affect simulation correctness and can be implemented post-E7:

#### 1. Event Log Emission
**Impact:** Replay/visualization only, not simulation-critical
**Handlers Affected:** Most intent handlers (transfer, withdraw, upgrade, attack, heal, build, harvest, etc.)

**What's needed:**
- Add event log infrastructure to `RoomProcessorContext`
- Implement `RecordTransferEvent`, `RecordUpgradeEvent`, etc. methods
- Call from all intent handlers
- Extend `RoomIntentEventLogStep` to serialize events

**Scope:** Cross-cutting concern affecting all handlers

#### 2. Level-Up Notifications
**Impact:** User experience only
**Handler:** `ControllerIntentStep` on level-up transitions

**What's needed:**
- Notification system infrastructure
- Call `driver.SendNotification(userId, message)` on controller level-up

#### 3. Stats Recording
**Impact:** Analytics only
**Handlers Affected:** PowerSpawn, Resource I/O, etc.

**What's needed:**
- Stats aggregation pipeline
- Track power processed, resources transferred, etc.
- Write to statistics collection

---

## Test Coverage Summary

**Total:** 240/240 tests passing

| Handler Family | Tests | Status |
|----------------|-------|--------|
| Movement | 25 | ✅ Complete |
| Spawn | 18 | ✅ Complete |
| Build/Repair | 12 | ✅ Complete |
| Harvest | 15 | ✅ Complete |
| Tower | 10 | ✅ Complete |
| Resource I/O | 31 | ✅ Complete |
| Controller | 12 | ✅ Complete |
| Lab | 27 | ✅ Complete |
| Link | 8 | ✅ Complete |
| Power Spawn | 9 | ✅ Complete |
| Factory | 11 | ✅ Complete |
| Power Abilities | 58 | ✅ Complete |
| Market | 4 | ✅ Complete |

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`
- **E5 Plan (Blockers):** `e5.md` - Lists E2 features blocked by E5, implementation order after E5 Phase 1/2 complete

---

**Last Updated:** January 21, 2026 (Plan condensed - removed verbose implementation details)
