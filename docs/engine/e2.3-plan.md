# E2.3 – Room Processor Handler Backlog

**Status:** Updated January 19, 2026

This document tracks the remaining intent handlers needed to complete E2.3 ("Wire engine consumption"). Once all handlers are ported from the Node.js engine, the .NET engine will be feature-complete for single-room simulation.

---

## Completed Handlers ✅

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ✅ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ✅ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ✅ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ✅ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ✅ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ✅ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ✅
- ✅ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (all operations working)
  - **Status:** 30/30 tests passing
  - **Infrastructure:** Lab mineral capacity tracking and power effect types implemented

### Global/Power Creep Handlers
- ✅ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ✅ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ✅ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ✅ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ✅ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ✅ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ✅ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Remaining Handlers ☐

The following handlers must be implemented to complete E2.3:

### 1. Controller Intents (High Priority)
**Blocked by:** Resource I/O completion (upgrade requires energy transfer)

- ☐ `ControllerIntentStep` to handle:
  - `upgradeController` - Consume energy, increment progress, handle RCL upgrades
  - `reserveController` - Set reservation timer and owner
  - `attackController` - Reduce reservation timer and progress

**Estimated effort:** 2-3 days
**Tests needed:** ~12 tests (upgrade power, RCL transitions, reservation, attacks, edge cases)

### 2. Lab Reactions & Boosts (High Priority)
**Blocked by:** Lab capacity tracking (requires `RoomObjectPatchPayload.StoreCapacityResource`)

- ☐ `LabIntentStep` to handle:
  - `runReaction` - Consume reagents, produce compounds, set cooldown
  - `boostCreep` - Apply boost effects, consume minerals, update creep body parts

**Estimated effort:** 3-4 days
**Tests needed:** ~15 tests (reactions, reagent validation, cooldowns, boost application, mineral consumption)

**Prerequisites:**
- Add `StoreCapacityResource` field to `RoomObjectPatchPayload`
- Add `BoostEffect` fields to `RoomObjectSnapshot` (creep body parts)
- Implement lab mineral capacity tracking logic

### 3. Structure Energy Routing (Medium Priority)

- ☐ `LinkIntentStep` - Energy transfers between links with cooldowns
- ☐ `FactoryIntentStep` - Commodity production with cooldowns/reagents
- ☐ `PowerSpawnIntentStep` - Process power into ops

**Estimated effort:** 4-5 days
**Tests needed:** ~20 tests total

### 4. Power Creep Abilities (Low Priority)
**Blocked by:** Power effect tracking (requires `PowerEffectTypes` constants and effect DTOs)

- ☐ `PowerCreepAbilityStep` to handle 19 power abilities:
  - `generateOps`, `operateSpawn`, `operateTower`, `operateStorage`, etc.
  - Each ability has unique validation, cooldowns, ranges, and effects

**Estimated effort:** 7-10 days
**Tests needed:** ~40+ tests (2-3 per ability)

**Prerequisites:**
- Add `PowerEffectTypes` enum with all 19 power effect types
- Add effect duration/magnitude tracking to `RoomObjectSnapshot`
- Implement power effect decay logic

---

## Resource I/O Implementation (Complete) ✅

The `ResourceTransferIntentStep` is **fully complete** with 30/30 tests passing.

### Implemented Infrastructure (January 19, 2026)

#### 1. StoreCapacityResource Field ✅
**Location:** `ScreepsDotNet.Driver/Contracts/RoomMutationBatch.cs`

Added resource-specific capacity tracking to `RoomObjectPatchPayload`:
```csharp
public IReadOnlyDictionary<string, int>? StoreCapacityResource { get; init; }
```

Serialization in `RoomContractMapper.CreateRoomObjectPatchDocument`:
```csharp
if (patch.StoreCapacityResource is { Count: > 0 }) {
    var capacityDocument = new BsonDocument();
    foreach (var (resourceType, capacity) in patch.StoreCapacityResource) {
        capacityDocument[resourceType] = capacity;
    }
    document[RoomDocumentFields.RoomObject.Store.CapacityResource] = capacityDocument;
}
```

#### 2. PowerEffectTypes Constants ✅
**Location:** `ScreepsDotNet.Common/Constants/PowerEffectTypes.cs`

Created constants for all 19 power effect types:
```csharp
public static class PowerEffectTypes
{
    public const int DisruptTerminal = 15;
    // ... all 19 power effect types
}
```

#### 3. Lab Capacity Tracking ✅
Implemented automatic capacity management in `ResourceTransferIntentStep`:
- **On first mineral transfer:** Sets `storeCapacityResource[mineralType] = 3000`
- **On energy transfer:** Does not modify capacity
- **On last mineral withdraw:** Clears `storeCapacityResource` (empty dictionary)

### All Features Working

The following **30 tests pass** and are fully functional:

**Transfer (8 tests):**
- Basic transfers between creeps/structures
- Amount auto-clamping (available, capacity)
- Multi-operation ledger accumulation
- Capacity overflow prevention
- Lab mineral capacity tracking (first transfer sets capacity)
- Lab energy transfers (do not set capacity)

**Withdraw (9 tests):**
- Basic withdraws from structures
- Safe mode blocking (enemy controlled rooms)
- Rampart blocking (private ramparts only)
- Amount auto-clamping
- Nuker/PowerBank blocking
- Terminal disruption effect (PWR_DISRUPT_TERMINAL blocks withdraw)
- Lab mineral capacity clearing (last withdraw clears capacity)

**Pickup (6 tests):**
- Ground drop pickup (full and partial)
- Tombstone blocking (type check)
- Adjacency validation
- Capacity constraints

**Drop (5 tests):**
- Ground drop creation
- Container priority (drops to container first)
- Drop stacking (merges with existing drops)
- Multi-operation accumulation

**Integration (2 tests):**
- Round-trip: Pickup → Transfer → Drop
- Lab workflow: Transfer in → Withdraw out (with capacity tracking)

### Implementation Notes

**Batch Emission Pattern:**
The handler uses a `HashSet<string> modifiedObjects` to track which objects had successful operations. Only these objects emit patches, preventing spurious mutations when validation fails.

```csharp
// Only modified objects emit patches
foreach (var objectId in modifiedObjects)
{
    if (storeLedger.TryGetValue(objectId, out var store))
    {
        context.MutationWriter.Patch(objectId, new RoomObjectPatchPayload
        {
            Store = new Dictionary<string, int>(store, Comparer)
        });
    }
}
```

**Store Ledger Accumulation:**
All operations read from and write to the ledger (not snapshots), ensuring correct sequencing when multiple creeps operate on the same target in one tick.

---

## Next Steps (Priority Order)

### ✅ Completed (January 19, 2026)
1. ✅ Complete Resource I/O handler (all operations working)
2. ✅ Add `StoreCapacityResource` field to `RoomObjectPatchPayload`
3. ✅ Add `PowerEffectTypes` constants
4. ✅ Complete all 30 Resource I/O tests
5. ✅ Implement lab mineral capacity tracking

### Short Term (Next 2 Weeks)
5. ☐ Implement `ControllerIntentStep` (upgrade, reserve, attack)
6. ☐ Implement basic lab reactions (without boost support initially)

### Medium Term (Next Month)
7. ☐ Implement structure energy routing (links, factory, power spawn)
8. ☐ Complete lab boost support
9. ☐ Begin power creep ability handlers (highest-value abilities first)

### Long Term
10. ☐ Complete all power creep ability handlers
11. ☐ E7 parity validation (lockstep testing vs Node.js engine)

---

## Test Coverage Summary

| Handler | Tests Written | Tests Passing | Deferred | Coverage |
|---------|---------------|---------------|----------|----------|
| Movement | 25 | 25 | 0 | ✅ Complete |
| Spawn | 18 | 18 | 0 | ✅ Complete |
| Build/Repair | 12 | 12 | 0 | ✅ Complete |
| Harvest | 15 | 15 | 0 | ✅ Complete |
| Tower | 10 | 10 | 0 | ✅ Complete |
| **Resource I/O** | **30** | **30** | **0** | ✅ **Complete** |
| Controller | 0 | 0 | 0 | ☐ Not started |
| Lab | 0 | 0 | 0 | ☐ Not started |
| Power Abilities | 0 | 0 | 0 | ☐ Not started |

**Overall E2.3 Progress:** ~75% complete (8/10 major handler families implemented)

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`

---

**Last Updated:** January 19, 2026
