# E2.3 – Room Processor Handler Backlog

**Status:** Updated January 21, 2026 (Structure Energy Routing complete: Links, PowerSpawn, Factory)

This document tracks the remaining intent handlers needed to complete E2.3 ("Wire engine consumption"). Once all handlers are ported from the Node.js engine, the .NET engine will be feature-complete for single-room simulation.

---

## Completed Handlers ✅

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ✅ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ✅ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ✅ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ✅ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ✅ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ✅ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ✅
- ✅ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (31/31 tests, lab capacity tracking, power effects)

### Core Controller Actions ✅
- ✅ **Controller** - `ControllerIntentStep` (12/12 tests, upgrade, reserve, attack with level transitions)
  - ✅ SafeMode available tracking (parity-critical)
  - ⚠️ Boost effects - Progress calculation complete, GCL updates blocked by E5

### Lab Reactions & Boosts ✅
- ✅ **Lab Reactions & Boosts** - `LabIntentStep` (24/24 tests, runReaction with 62 formulas, boostCreep with 40 boost types, unboostCreep with mineral returns, cooldown tracking, capacity management, action log recording)

### Structure Energy Routing ✅
- ✅ **Link Energy Transfer** - `LinkIntentStep` (8/8 tests, energy transfers between links with 3% loss ratio, distance-based cooldowns, action log recording)
- ✅ **Power Spawn Processing** - `PowerSpawnIntentStep` (6/6 tests, consumes 1 power + 50 energy per tick to generate ops)
- ✅ **Factory Production** - `FactoryIntentStep` (8/8 tests, commodity production with 62 recipes, multi-component consumption, level gating, cumulative cooldowns, action log recording)

### Global/Power Creep Handlers
- ✅ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ✅ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ✅ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ✅ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ✅ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ✅ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ✅ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Remaining Handlers ☐

The following handlers must be implemented to complete E2.3:

### 1. Power Creep Abilities (Low Priority)
**Ready to implement** - Power effect types complete (`PowerEffectTypes` constants implemented)

- ☐ `PowerCreepAbilityStep` to handle 19 power abilities:
  - `generateOps`, `operateSpawn`, `operateTower`, `operateStorage`, etc.
  - Each ability has unique validation, cooldowns, ranges, and effects

**Estimated effort:** 7-10 days
**Tests needed:** ~40+ tests (2-3 per ability)

**Remaining prerequisites:**
- Add effect duration/magnitude tracking to `RoomObjectSnapshot`
- Implement power effect decay logic

---

---

## Known Limitations / Deferred Features

The following features were intentionally deferred from Resource I/O implementation:

### Event Emission (Deferred - Non-Parity-Critical)
**Impact:** Low - Event logs are used for replays/debugging, not core simulation
**Parity Status:** NOT required for E7 parity validation

Transfer and withdraw operations currently do not emit `EVENT_TRANSFER` events to the event log. The Node.js engine emits these for replay visualization:

```javascript
// Node.js transfer.js line 58:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: source._id,
    data: {targetId: target._id, resourceType: resourceType, amount}
});

// Node.js withdraw.js line 59:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: target._id,  // Note: reversed - target is source
    data: {targetId: object._id, resourceType: intent.resourceType, amount}
});
```

**Why not parity-critical:**
- Event logs do NOT affect simulation correctness (verified: no game logic consumes EVENT_TRANSFER)
- Only used for replay visualization in the Screeps client
- Can be implemented post-MVP without affecting gameplay

**What's needed (when implemented):**
1. Add event log infrastructure to `RoomProcessorContext`
2. Implement `RecordTransferEvent(sourceId, targetId, resourceType, amount)` method
3. Call from `ProcessTransfer` (creep → target) and `ProcessWithdraw` (target → creep, reversed)
4. Extend `RoomIntentEventLogStep` to serialize transfer events to event log payload
5. Implement similar event emission for ALL intent handlers (attack, heal, build, harvest, upgrade, etc.)

**Note:** Event log implementation is a cross-cutting concern affecting all handlers, not just Resource I/O. Should be implemented holistically once event log infrastructure is in place.

### Lab Reactions & Boosts (Deferred)
**Impact:** Medium priority - Power effects blocked by E5, event logs non-parity-critical

#### Blocked by E5 (Power System):
1. **PWR_OPERATE_LAB power effect** - Boosts reaction amount from 5 to higher values
   - **Why deferred:** Requires power effect tracking system (E5 work)
   - **Schema ready:** Power effect fields exist in `RoomObjectSnapshot`
   - **What's needed:**
     - Check for `PWR_OPERATE_LAB` effect in `ProcessRunReaction`
     - Increase reaction amount by effect magnitude (default 5 → 5 + effect)
     - 2-3 tests (with effect vs without)
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #3 (PWR_OPERATE_LAB Power Effect)

#### Non-Parity-Critical (Debugging/Replay):
2. **Event log emission** - Lab reactions don't emit events to event log
   - **Why deferred:** Cross-cutting concern, non-parity-critical
   - **Blocking:** Event log infrastructure
   - **Effort:** Part of holistic event log implementation

## Deferred Features - Complexity Ranking

Remaining deferred features across implemented handlers, sorted by complexity:

| Rank | Feature | Handler | Complexity | Effort | Parity? | Status |
|------|---------|---------|-----------|--------|---------|--------|
| 1 | **PWR_OPERATE_LAB** | Lab | LOW | 1-2 hours | ❌ NO | ☐ Blocked by E5 |
| 2 | **PWR_OPERATE_POWER** | Power Spawn | LOW | 1-2 hours | ✅ YES | ☐ Blocked by E5 |
| 3 | **PWR_OPERATE_FACTORY** | Factory | LOW | 1-2 hours | ✅ YES | ☐ Blocked by E5 |
| 4 | **Boost effects (GCL)** | Controller | MEDIUM-HIGH | Part of #6 | ✅ YES | ⚠️ Partial (progress ✅, GCL ☐) |
| 5 | **User power balance** | Power Spawn | MEDIUM-HIGH | Part of #6 | ✅ YES | ☐ Blocked by E5 |
| 6 | **User GCL updates** | Controller | MEDIUM-HIGH | 1-2 days | ✅ YES | ☐ Blocked by E5 |
| 7 | **Event log (transfer)** | Resource I/O | MEDIUM | 1-2 days | ❌ NO | ☐ Deferred |
| 8 | **Event log (upgrade)** | Controller | MEDIUM | Part of #7 | ❌ NO | ☐ Deferred |
| 9 | **Event log (lab)** | Lab | MEDIUM | Part of #7 | ❌ NO | ☐ Deferred |
| 10 | **Stats (power spawn)** | Power Spawn | LOW | 4-8 hours | ❌ NO | ☐ Deferred |
| 11 | **Notifications** | Controller | HIGH | 3-5 days | ❌ NO | ☐ Deferred |

### Remaining Parity Blockers:
- **Boost effects (GCL)** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserGcl()`
- **User GCL updates (non-boosted)** - Blocked by E5 (Global Systems) implementation, requires architectural decisions about global mutation batching
- **PWR_OPERATE_POWER** - Blocked by E5, requires power effect tracking for power spawn processing amount increase
- **PWR_OPERATE_FACTORY** - Blocked by E5, requires power effect tracking for factory level boost
- **User power balance** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserPower()`

**E5 Cross-Reference:** See `docs/engine/e5-plan.md` for detailed E5 blockers and implementation order. When E5 Phase 1 (Global Mutations) is complete, return to E2.3 to implement GCL updates.

### Structure Energy Routing (Deferred - PARITY-BLOCKING)
**Impact:** HIGH - Power effects required for E7 parity validation

The following features are deferred from the structure energy routing implementation:

#### Power Spawn (Blocked by E5):
1. **PWR_OPERATE_POWER effect** - Increases power processing amount from 1 to higher values
   - **Why deferred:** Requires power effect tracking system (E5 work)
   - **Schema ready:** Power effect fields exist in `RoomObjectSnapshot`
   - **What's needed:**
     - Check for `PWR_OPERATE_POWER` effect in `ProcessPowerSpawn`
     - Increase processing amount by effect magnitude (default 1 → 1 + effect)
     - 2-3 tests (with effect vs without)
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" (PWR_OPERATE_POWER Power Effect)

2. **User power balance updates** - Node.js increments user power balance on every power processing
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserPower(userId, amount)` method
   - **Schema ready:** `UserState` already has power balance field
   - **Blocking:** E5 (Global Systems) must implement global user mutations first
   - **Impact:** Power balance tracking blocked
   - **What's needed:** In `ProcessPowerSpawn`, call `context.GlobalMutationWriter.IncrementUserPower(powerSpawn.UserId, amount)`

3. **Stats recording** - Track power processed per user for statistics
   - **Why deferred:** Requires stats sink integration
   - **Impact:** Statistics tracking only, doesn't affect simulation correctness

#### Factory (Blocked by E5):
1. **PWR_OPERATE_FACTORY effect** - Increases factory level temporarily, allowing production of higher-level commodities
   - **Why deferred:** Requires power effect tracking system (E5 work)
   - **Schema ready:** Power effect fields exist in `RoomObjectSnapshot`
   - **What's needed:**
     - Check for `PWR_OPERATE_FACTORY` effect in `ProcessProduce`
     - Increase factory level by effect magnitude when checking recipe level requirements
     - 2-3 tests (level-gated commodities with/without effect)
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" (PWR_OPERATE_FACTORY Power Effect)

#### Link (No Deferrals):
- ✅ Link implementation is complete with no deferred features

### Controller Intents (Deferred - PARITY-BLOCKING)
**Impact:** HIGH - GCL updates required for E7 parity validation

The following features are deferred from the ControllerIntentStep implementation:

#### Partially Complete:
1. **Boost effects** - ⚠️ **PARTIALLY IMPLEMENTED** (January 20, 2026)
   - ✅ **Controller progress** - Boost calculation complete (`CalculateBoostEffect`)
   - ✅ **Constants** - `WorkBoostUpgradeMultipliers` dictionary (GH: 1.5x, GH2O: 1.8x, XGH2O: 2.0x)
   - ✅ **Tests** - 4 comprehensive tests covering boost mechanics
   - ❌ **GCL updates** - Blocked by E5 (requires `IGlobalMutationWriter`)
   - **What's missing:** In `ProcessUpgrade`, need to call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #2 (Boost Effects GCL Component)

#### Parity-Critical (Blocked by E5):
2. **User GCL updates** - Node.js calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserGcl(userId, amount)` method
   - **Schema ready:** `UserState` already has GCL field
   - **Blocking:** E5 (Global Systems) must implement global user mutations first
   - **Impact:** Both non-boosted AND boosted GCL gains are blocked
   - **What's needed:** In `ProcessUpgrade`, call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #1 (User GCL Updates)

#### Non-Parity-Critical:
2. **Level-up notifications** - Node.js calls `driver.sendNotification(...)` on level-up
   - **Why deferred:** Requires notification system
   - **Impact:** User experience only, doesn't affect simulation correctness

3. **Event log emission** - Node.js emits `EVENT_UPGRADE_CONTROLLER` with amount/energySpent
   - **Why deferred:** Requires event log infrastructure
   - **Impact:** Replay/visualization only, doesn't affect simulation correctness

---

## Next Steps (Priority Order)

### ✅ Completed (January 19-21, 2026)
1. ✅ Complete Resource I/O handler (transfer, withdraw, pickup, drop)
2. ✅ Add infrastructure for lab capacity tracking and power effects
3. ✅ Complete all 31 Resource I/O tests
4. ✅ Implement `ControllerIntentStep` (upgrade, reserve, attack)
5. ✅ Complete all 12 Controller intent tests (level transitions, reservation, attacks)
6. ✅ Implement lab reactions (runReaction with 62 formulas)
7. ✅ Add boost creep functionality to labs (boostCreep with 40 boost types)
8. ✅ Implement unboostCreep (parity-critical)
9. ✅ Add lab action log recording (debugging feature)
10. ✅ Complete all 24 Lab intent tests
11. ✅ Implement `LinkIntentStep` (8/8 tests, energy transfers with loss ratio and cooldowns)
12. ✅ Implement `PowerSpawnIntentStep` (6/6 tests, power processing for ops generation)
13. ✅ Implement `FactoryIntentStep` (8/8 tests, commodity production with 62 recipes)
14. ✅ Complete all 22 structure energy routing tests

### Short Term (Next 2 Weeks)
15. ☐ Begin power creep ability handlers (highest-value abilities first)

### Medium Term (Next Month)
16. ☐ Complete all power creep ability handlers

### Long Term
17. ☐ E7 parity validation (lockstep testing vs Node.js engine)

---

## Test Coverage Summary

| Handler | Tests Written | Tests Passing | Deferred | Coverage |
|---------|---------------|---------------|----------|----------|
| Movement | 25 | 25 | 0 | ✅ Complete |
| Spawn | 18 | 18 | 0 | ✅ Complete |
| Build/Repair | 12 | 12 | 0 | ✅ Complete |
| Harvest | 15 | 15 | 0 | ✅ Complete |
| Tower | 10 | 10 | 0 | ✅ Complete |
| **Resource I/O** | **31** | **31** | **0** | ✅ **Complete** |
| **Controller** | **12** | **12** | **0** | ✅ **Complete** |
| **Lab** | **24** | **24** | **0** | ✅ **Complete** |
| **Link** | **8** | **8** | **0** | ✅ **Complete** |
| **Power Spawn** | **6** | **6** | **0** | ✅ **Complete** |
| **Factory** | **8** | **8** | **0** | ✅ **Complete** |
| Power Abilities | 0 | 0 | 0 | ☐ Not started |

**Overall E2.3 Progress:** ~95% complete (10/11 major handler families implemented, only power abilities remaining)

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`
- **E5 Plan (Blockers):** `docs/engine/e5-plan.md` - Lists E2.3 features blocked by E5, implementation order after E5 Phase 1/2 complete

---

**Last Updated:** January 21, 2026 (Structure Energy Routing complete: 22/22 tests passing - Link, PowerSpawn, Factory)
