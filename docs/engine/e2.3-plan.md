# E2.3 – Room Processor Handler Backlog

**Status:** Updated January 20, 2026 (Lab Reactions & Boosts complete with UnboostCreep + Action Log)

This document tracks the remaining intent handlers needed to complete E2.3 ("Wire engine consumption"). Once all handlers are ported from the Node.js engine, the .NET engine will be feature-complete for single-room simulation.

---

## Completed Handlers ✅

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ✅ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ✅ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ✅ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ✅ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ✅ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ✅ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ✅
- ✅ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (31/31 tests, lab capacity tracking, power effects)

### Core Controller Actions ✅
- ✅ **Controller** - `ControllerIntentStep` (12/12 tests, upgrade, reserve, attack with level transitions)
  - ✅ SafeMode available tracking (parity-critical)
  - ⚠️ Boost effects - Progress calculation complete, GCL updates blocked by E5

### Lab Reactions & Boosts ✅
- ✅ **Lab Reactions & Boosts** - `LabIntentStep` (24/24 tests, runReaction with 62 formulas, boostCreep with 40 boost types, unboostCreep with mineral returns, cooldown tracking, capacity management, action log recording)

### Global/Power Creep Handlers
- ✅ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ✅ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ✅ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ✅ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ✅ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ✅ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ✅ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Remaining Handlers ☐

The following handlers must be implemented to complete E2.3:

### 1. Structure Energy Routing (Medium Priority)

- ☐ `LinkIntentStep` - Energy transfers between links with cooldowns
- ☐ `FactoryIntentStep` - Commodity production with cooldowns/reagents
- ☐ `PowerSpawnIntentStep` - Process power into ops

**Estimated effort:** 4-5 days
**Tests needed:** ~20 tests total

### 2. Power Creep Abilities (Low Priority)
**Ready to implement** - Power effect types complete (`PowerEffectTypes` constants implemented)

- ☐ `PowerCreepAbilityStep` to handle 19 power abilities:
  - `generateOps`, `operateSpawn`, `operateTower`, `operateStorage`, etc.
  - Each ability has unique validation, cooldowns, ranges, and effects

**Estimated effort:** 7-10 days
**Tests needed:** ~40+ tests (2-3 per ability)

**Remaining prerequisites:**
- Add effect duration/magnitude tracking to `RoomObjectSnapshot`
- Implement power effect decay logic

---

---

## Known Limitations / Deferred Features

The following features were intentionally deferred from Resource I/O implementation:

### Event Emission (Deferred - Non-Parity-Critical)
**Impact:** Low - Event logs are used for replays/debugging, not core simulation
**Parity Status:** NOT required for E7 parity validation

Transfer and withdraw operations currently do not emit `EVENT_TRANSFER` events to the event log. The Node.js engine emits these for replay visualization:

```javascript
// Node.js transfer.js line 58:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: source._id,
    data: {targetId: target._id, resourceType: resourceType, amount}
});

// Node.js withdraw.js line 59:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: target._id,  // Note: reversed - target is source
    data: {targetId: object._id, resourceType: intent.resourceType, amount}
});
```

**Why not parity-critical:**
- Event logs do NOT affect simulation correctness (verified: no game logic consumes EVENT_TRANSFER)
- Only used for replay visualization in the Screeps client
- Can be implemented post-MVP without affecting gameplay

**What's needed (when implemented):**
1. Add event log infrastructure to `RoomProcessorContext`
2. Implement `RecordTransferEvent(sourceId, targetId, resourceType, amount)` method
3. Call from `ProcessTransfer` (creep → target) and `ProcessWithdraw` (target → creep, reversed)
4. Extend `RoomIntentEventLogStep` to serialize transfer events to event log payload
5. Implement similar event emission for ALL intent handlers (attack, heal, build, harvest, upgrade, etc.)

**Note:** Event log implementation is a cross-cutting concern affecting all handlers, not just Resource I/O. Should be implemented holistically once event log infrastructure is in place.

### Lab Reactions & Boosts (Deferred)
**Impact:** Medium priority - Power effects blocked by E5, event logs non-parity-critical

#### Blocked by E5 (Power System):
1. **PWR_OPERATE_LAB power effect** - Boosts reaction amount from 5 to higher values
   - **Why deferred:** Requires power effect tracking system (E5 work)
   - **Schema ready:** Power effect fields exist in `RoomObjectSnapshot`
   - **What's needed:**
     - Check for `PWR_OPERATE_LAB` effect in `ProcessRunReaction`
     - Increase reaction amount by effect magnitude (default 5 → 5 + effect)
     - 2-3 tests (with effect vs without)
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #3 (PWR_OPERATE_LAB Power Effect)

#### Non-Parity-Critical (Debugging/Replay):
2. **Event log emission** - Lab reactions don't emit events to event log
   - **Why deferred:** Cross-cutting concern, non-parity-critical
   - **Blocking:** Event log infrastructure
   - **Effort:** Part of holistic event log implementation

## Deferred Features - Complexity Ranking

Remaining deferred features across implemented handlers, sorted by complexity:

| Rank | Feature | Handler | Complexity | Effort | Parity? | Status |
|------|---------|---------|-----------|--------|---------|--------|
| 1 | **PWR_OPERATE_LAB** | Lab | LOW | 1-2 hours | ❌ NO | ☐ Blocked by E5 |
| 2 | **Boost effects (GCL)** | Controller | MEDIUM-HIGH | Part of #3 | ✅ YES | ⚠️ Partial (progress ✅, GCL ☐) |
| 3 | **User GCL updates** | Controller | MEDIUM-HIGH | 1-2 days | ✅ YES | ☐ Blocked by E5 |
| 4 | **Event log (transfer)** | Resource I/O | MEDIUM | 1-2 days | ❌ NO | ☐ Deferred |
| 5 | **Event log (upgrade)** | Controller | MEDIUM | Part of #4 | ❌ NO | ☐ Deferred |
| 6 | **Event log (lab)** | Lab | MEDIUM | Part of #4 | ❌ NO | ☐ Deferred |
| 7 | **Notifications** | Controller | HIGH | 3-5 days | ❌ NO | ☐ Deferred |

### Remaining Parity Blockers:
- **Boost effects (GCL)** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserGcl()`
- **User GCL updates (non-boosted)** - Blocked by E5 (Global Systems) implementation, requires architectural decisions about global mutation batching

**E5 Cross-Reference:** See `docs/engine/e5-plan.md` for detailed E5 blockers and implementation order. When E5 Phase 1 (Global Mutations) is complete, return to E2.3 to implement GCL updates.

### Controller Intents (Deferred - PARITY-BLOCKING)
**Impact:** HIGH - GCL updates required for E7 parity validation

The following features are deferred from the ControllerIntentStep implementation:

#### Partially Complete:
1. **Boost effects** - ⚠️ **PARTIALLY IMPLEMENTED** (January 20, 2026)
   - ✅ **Controller progress** - Boost calculation complete (`CalculateBoostEffect`)
   - ✅ **Constants** - `WorkBoostUpgradeMultipliers` dictionary (GH: 1.5x, GH2O: 1.8x, XGH2O: 2.0x)
   - ✅ **Tests** - 4 comprehensive tests covering boost mechanics
   - ❌ **GCL updates** - Blocked by E5 (requires `IGlobalMutationWriter`)
   - **What's missing:** In `ProcessUpgrade`, need to call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #2 (Boost Effects GCL Component)

#### Parity-Critical (Blocked by E5):
2. **User GCL updates** - Node.js calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserGcl(userId, amount)` method
   - **Schema ready:** `UserState` already has GCL field
   - **Blocking:** E5 (Global Systems) must implement global user mutations first
   - **Impact:** Both non-boosted AND boosted GCL gains are blocked
   - **What's needed:** In `ProcessUpgrade`, call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #1 (User GCL Updates)

#### Non-Parity-Critical:
2. **Level-up notifications** - Node.js calls `driver.sendNotification(...)` on level-up
   - **Why deferred:** Requires notification system
   - **Impact:** User experience only, doesn't affect simulation correctness

3. **Event log emission** - Node.js emits `EVENT_UPGRADE_CONTROLLER` with amount/energySpent
   - **Why deferred:** Requires event log infrastructure
   - **Impact:** Replay/visualization only, doesn't affect simulation correctness

---

## Next Steps (Priority Order)

### ✅ Completed (January 19-20, 2026)
1. ✅ Complete Resource I/O handler (transfer, withdraw, pickup, drop)
2. ✅ Add infrastructure for lab capacity tracking and power effects
3. ✅ Complete all 31 Resource I/O tests
4. ✅ Implement `ControllerIntentStep` (upgrade, reserve, attack)
5. ✅ Complete all 12 Controller intent tests (level transitions, reservation, attacks)
6. ✅ Implement lab reactions (runReaction with 62 formulas)
7. ✅ Add boost creep functionality to labs (boostCreep with 40 boost types)
8. ✅ Implement unboostCreep (parity-critical)
9. ✅ Add lab action log recording (debugging feature)
10. ✅ Complete all 24 Lab intent tests

### Short Term (Next 2 Weeks)
11. ☐ Implement structure energy routing (links, factory, power spawn)

### Medium Term (Next Month)
12. ☐ Begin power creep ability handlers (highest-value abilities first)

### Long Term
13. ☐ Complete all power creep ability handlers
14. ☐ E7 parity validation (lockstep testing vs Node.js engine)

---

## Test Coverage Summary

| Handler | Tests Written | Tests Passing | Deferred | Coverage |
|---------|---------------|---------------|----------|----------|
| Movement | 25 | 25 | 0 | ✅ Complete |
| Spawn | 18 | 18 | 0 | ✅ Complete |
| Build/Repair | 12 | 12 | 0 | ✅ Complete |
| Harvest | 15 | 15 | 0 | ✅ Complete |
| Tower | 10 | 10 | 0 | ✅ Complete |
| **Resource I/O** | **31** | **31** | **0** | ✅ **Complete** |
| **Controller** | **12** | **12** | **0** | ✅ **Complete** |
| **Lab** | **24** | **24** | **0** | ✅ **Complete** |
| Power Abilities | 0 | 0 | 0 | ☐ Not started |

**Overall E2.3 Progress:** ~85% complete (9/10 major handler families implemented, lab complete with action log + unboost)

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`
- **E5 Plan (Blockers):** `docs/engine/e5-plan.md` - Lists E2.3 features blocked by E5, implementation order after E5 Phase 1/2 complete

---

**Last Updated:** January 20, 2026 (Lab implementation complete: 24/24 tests passing)
