# E2.3 – Room Processor Handler Backlog

**Status:** 95% Complete - January 21, 2026 (11/11 handler families implemented, 240/240 tests passing, 4 features blocked by E5)

**Completed:** All room-level intent processing handlers
**Blocked:** 4 features require E5 (Global Systems) infrastructure:
- ❌ PWR_GENERATE_OPS power ability (requires global power balance)
- ❌ User power balance tracking in PowerSpawn (requires `IGlobalMutationWriter.IncrementUserPower`)
- ❌ User GCL updates in Controller (requires `IGlobalMutationWriter.IncrementUserGcl`)
- ❌ Boost effects GCL component in Controller (requires `IGlobalMutationWriter.IncrementUserGcl`)

This document tracks intent handlers for E2.3 ("Wire engine consumption"). All 11 major handler families are implemented and tested. Remaining 5% is blocked by E5 (Global Systems) which provides global mutation infrastructure (`IGlobalMutationWriter`).

---

## Completed Handlers ✅

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ✅ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ✅ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ✅ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ✅ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ✅ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ✅ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ✅
- ✅ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (31/31 tests, lab capacity tracking, power effects)

### Core Controller Actions ✅
- ✅ **Controller** - `ControllerIntentStep` (12/12 tests, upgrade, reserve, attack with level transitions)
  - ✅ SafeMode available tracking (parity-critical)
  - ⚠️ Boost effects - Progress calculation complete, GCL updates blocked by E5

### Lab Reactions & Boosts ✅
- ✅ **Lab Reactions & Boosts** - `LabIntentStep` (27/27 tests, runReaction with 62 formulas, boostCreep with 40 boost types, unboostCreep with mineral returns, cooldown tracking, capacity management, action log recording, PWR_OPERATE_LAB effect support)

### Structure Energy Routing ✅
- ✅ **Link Energy Transfer** - `LinkIntentStep` (8/8 tests, energy transfers between links with 3% loss ratio, distance-based cooldowns, action log recording)
- ✅ **Power Spawn Processing** - `PowerSpawnIntentStep` (9/9 tests, consumes 1 power + 50 energy per tick to generate ops, PWR_OPERATE_POWER effect support)
- ✅ **Factory Production** - `FactoryIntentStep` (11/11 tests, commodity production with 62 recipes, multi-component consumption, level gating, cumulative cooldowns, action log recording, PWR_OPERATE_FACTORY effect support)

### Global/Power Creep Handlers
- ✅ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ✅ **Power Creep Abilities** - `PowerAbilityStep` (58/58 tests: 4 decay + 10 core + 32 effect-based + 12 direct-action)
  - ✅ Effect decay logic (`PowerEffectDecayStep`)
  - ✅ All 18 power abilities implemented (generateOps deferred to E5)
  - ⚠️ generateOps ability - Blocked by E5 (requires global power balance tracking)
- ✅ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ✅ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ✅ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ✅ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ✅ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ✅ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Remaining Handlers ☐

**E2.3 is now 100% complete!** All major handler families have been implemented and tested.

All planned work is complete:
- ✅ Power effect consumption - Lab/PowerSpawn/Factory handlers check and consume power effects (9/9 tests)
- ✅ Integration & Documentation - All steps registered in ServiceCollectionExtensions, 240/240 tests passing

---

---

## Known Limitations / Deferred Features

The following features were intentionally deferred from Resource I/O implementation:

### Event Emission (Deferred - Non-Parity-Critical)
**Impact:** Low - Event logs are used for replays/debugging, not core simulation
**Parity Status:** NOT required for E7 parity validation

Transfer and withdraw operations currently do not emit `EVENT_TRANSFER` events to the event log. The Node.js engine emits these for replay visualization:

```javascript
// Node.js transfer.js line 58:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: source._id,
    data: {targetId: target._id, resourceType: resourceType, amount}
});

// Node.js withdraw.js line 59:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: target._id,  // Note: reversed - target is source
    data: {targetId: object._id, resourceType: intent.resourceType, amount}
});
```

**Why not parity-critical:**
- Event logs do NOT affect simulation correctness (verified: no game logic consumes EVENT_TRANSFER)
- Only used for replay visualization in the Screeps client
- Can be implemented post-MVP without affecting gameplay

**What's needed (when implemented):**
1. Add event log infrastructure to `RoomProcessorContext`
2. Implement `RecordTransferEvent(sourceId, targetId, resourceType, amount)` method
3. Call from `ProcessTransfer` (creep → target) and `ProcessWithdraw` (target → creep, reversed)
4. Extend `RoomIntentEventLogStep` to serialize transfer events to event log payload
5. Implement similar event emission for ALL intent handlers (attack, heal, build, harvest, upgrade, etc.)

**Note:** Event log implementation is a cross-cutting concern affecting all handlers, not just Resource I/O. Should be implemented holistically once event log infrastructure is in place.

### Power Creep Abilities (Deferred)
**Impact:** Low - Only 1 of 19 abilities affected, power balance tracking isolated to generateOps

#### Blocked by E5 (Global Systems):
1. **PWR_GENERATE_OPS power ability** - Generates ops for power creep from global power balance
   - **Why deferred:** Requires `IGlobalMutationWriter.IncrementUserPower(userId, amount)` to track global power balance
   - **Node.js behavior (lines 57-69):** Adds ops to power creep store, drops overflow if exceeds capacity
   - **What's needed:**
     - E5 Phase 1: Implement `IGlobalMutationWriter` with power balance tracking
     - Add generateOps case to `PowerAbilityStep.ProcessUsePower` switch
     - Calculate ops amount: `powerInfo.Effect[level - 1]` (1/2/4/6/8 ops)
     - Add ops to power creep store, drop overflow
     - 2 tests: valid use (ops added), overflow (drops created)
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #5 (PWR_GENERATE_OPS)
   - **Effort:** 1-2 hours once E5 Phase 1 complete

### Lab Reactions & Boosts (Deferred Features)

#### Power Effects:
1. ✅ **PWR_OPERATE_LAB power effect** - COMPLETE (January 21, 2026)
   - ✅ Effect consumption implemented in `LabIntentStep.ProcessRunReaction`
   - ✅ Boosts reaction amount from base 5 to 5 + effect bonus (levels 1-5: 7/9/11/13/15 total)
   - ✅ 3 tests added (effect levels 1/3/5)
   - ✅ PowerInfo Effect array already existed: [2, 4, 6, 8, 10]

#### Non-Parity-Critical (Debugging/Replay):
2. **Event log emission** - Lab reactions don't emit events to event log
   - **Why deferred:** Cross-cutting concern, non-parity-critical
   - **Blocking:** Event log infrastructure
   - **Effort:** Part of holistic event log implementation

## Deferred Features - Complexity Ranking

Remaining deferred features across implemented handlers, sorted by complexity:

| Rank | Feature | Handler | Complexity | Effort | Parity? | Status |
|------|---------|---------|-----------|--------|---------|--------|
| 1 | **PWR_OPERATE_LAB** | Lab | LOW | 1-2 hours | ❌ NO | ✅ COMPLETE (Jan 21) |
| 2 | **PWR_OPERATE_POWER** | Power Spawn | LOW | 1-2 hours | ✅ YES | ✅ COMPLETE (Jan 21) |
| 3 | **PWR_OPERATE_FACTORY** | Factory | LOW | 1-2 hours | ✅ YES | ✅ COMPLETE (Jan 21) |
| 4 | **PWR_GENERATE_OPS** | Power Abilities | LOW | 1-2 hours | ✅ YES | ☐ Blocked by E5 |
| 5 | **Boost effects (GCL)** | Controller | MEDIUM-HIGH | Part of #7 | ✅ YES | ⚠️ Partial (progress ✅, GCL ☐) |
| 6 | **User power balance** | Power Spawn | MEDIUM-HIGH | Part of #7 | ✅ YES | ☐ Blocked by E5 |
| 7 | **User GCL updates** | Controller | MEDIUM-HIGH | 1-2 days | ✅ YES | ☐ Blocked by E5 |
| 7 | **Event log (transfer)** | Resource I/O | MEDIUM | 1-2 days | ❌ NO | ☐ Deferred |
| 8 | **Event log (upgrade)** | Controller | MEDIUM | Part of #7 | ❌ NO | ☐ Deferred |
| 9 | **Event log (lab)** | Lab | MEDIUM | Part of #7 | ❌ NO | ☐ Deferred |
| 10 | **Stats (power spawn)** | Power Spawn | LOW | 4-8 hours | ❌ NO | ☐ Deferred |
| 11 | **Notifications** | Controller | HIGH | 3-5 days | ❌ NO | ☐ Deferred |

### Remaining Parity Blockers:
- **Boost effects (GCL)** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserGcl()`
- **User GCL updates (non-boosted)** - Blocked by E5 (Global Systems) implementation, requires architectural decisions about global mutation batching
- **PWR_GENERATE_OPS** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserPower()` for ops generation
- **User power balance** - Blocked by E5, requires `IGlobalMutationWriter.IncrementUserPower()` for power spawn processing

**E5 Cross-Reference:** See `docs/engine/e5-plan.md` for detailed E5 blockers and implementation order. When E5 Phase 1 (Global Mutations) is complete, return to E2.3 to implement GCL updates.

### Structure Energy Routing (Deferred Features)

#### Power Spawn:
1. ✅ **PWR_OPERATE_POWER effect** - COMPLETE (January 21, 2026)
   - ✅ Effect consumption implemented in `PowerSpawnIntentStep.ProcessPowerSpawn`
   - ✅ Increases processing amount from base 1 to 1 + effect bonus (levels 1-5: 2/3/4/5/6 total)
   - ✅ 3 tests added (effect levels 1/3/5)
   - ✅ PowerInfo Effect array added: [1, 2, 3, 4, 5]

2. ☐ **User power balance updates** - Node.js increments user power balance on every power processing
   - **Status:** BLOCKED by E5 (Global Systems)
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserPower(userId, amount)` method
   - **Schema ready:** `UserState` already has power balance field
   - **What's needed:** In `ProcessPowerSpawn`, call `context.GlobalMutationWriter.IncrementUserPower(powerSpawn.UserId, amount)`
   - **Parity:** ✅ YES (required for E7 validation)

3. ☐ **Stats recording** - Track power processed per user for statistics
   - **Status:** DEFERRED (non-parity-critical)
   - **Impact:** Statistics tracking only, doesn't affect simulation correctness

#### Factory:
1. ✅ **PWR_OPERATE_FACTORY effect** - COMPLETE (January 21, 2026)
   - ✅ Effect consumption implemented in `FactoryIntentStep.ProcessProduce`
   - ✅ Increases factory level temporarily, allowing production of higher-level commodities
   - ✅ 3 tests added (effect levels 1/3/5 allowing level 1/3/5 commodities)
   - ✅ PowerInfo Effect array added: [1, 2, 3, 4, 5]

#### Link (No Deferrals):
- ✅ Link implementation is complete with no deferred features

### Controller Intents (Deferred - PARITY-BLOCKING)
**Impact:** HIGH - GCL updates required for E7 parity validation

The following features are deferred from the ControllerIntentStep implementation:

#### Partially Complete:
1. **Boost effects** - ⚠️ **PARTIALLY IMPLEMENTED** (January 20, 2026)
   - ✅ **Controller progress** - Boost calculation complete (`CalculateBoostEffect`)
   - ✅ **Constants** - `WorkBoostUpgradeMultipliers` dictionary (GH: 1.5x, GH2O: 1.8x, XGH2O: 2.0x)
   - ✅ **Tests** - 4 comprehensive tests covering boost mechanics
   - ❌ **GCL updates** - Blocked by E5 (requires `IGlobalMutationWriter`)
   - **What's missing:** In `ProcessUpgrade`, need to call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #2 (Boost Effects GCL Component)

#### Parity-Critical (Blocked by E5):
2. **User GCL updates** - Node.js calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserGcl(userId, amount)` method
   - **Schema ready:** `UserState` already has GCL field
   - **Blocking:** E5 (Global Systems) must implement global user mutations first
   - **Impact:** Both non-boosted AND boosted GCL gains are blocked
   - **What's needed:** In `ProcessUpgrade`, call `context.GlobalMutationWriter.IncrementUserGcl(creep.UserId, progressGain)`
   - **E5 Reference:** See `docs/engine/e5-plan.md` → "Blocked E2.3 Features" #1 (User GCL Updates)

#### Non-Parity-Critical:
2. **Level-up notifications** - Node.js calls `driver.sendNotification(...)` on level-up
   - **Why deferred:** Requires notification system
   - **Impact:** User experience only, doesn't affect simulation correctness

3. **Event log emission** - Node.js emits `EVENT_UPGRADE_CONTROLLER` with amount/energySpent
   - **Why deferred:** Requires event log infrastructure
   - **Impact:** Replay/visualization only, doesn't affect simulation correctness

---

## Next Steps (Priority Order)

### ✅ Completed (January 19-21, 2026)
1. ✅ Complete Resource I/O handler (transfer, withdraw, pickup, drop)
2. ✅ Add infrastructure for lab capacity tracking and power effects
3. ✅ Complete all 31 Resource I/O tests
4. ✅ Implement `ControllerIntentStep` (upgrade, reserve, attack)
5. ✅ Complete all 12 Controller intent tests (level transitions, reservation, attacks)
6. ✅ Implement lab reactions (runReaction with 62 formulas)
7. ✅ Add boost creep functionality to labs (boostCreep with 40 boost types)
8. ✅ Implement unboostCreep (parity-critical)
9. ✅ Add lab action log recording (debugging feature)
10. ✅ Complete all 24 Lab intent tests
11. ✅ Implement `LinkIntentStep` (8/8 tests, energy transfers with loss ratio and cooldowns)
12. ✅ Implement `PowerSpawnIntentStep` (6/6 tests, power processing for ops generation)
13. ✅ Implement `FactoryIntentStep` (8/8 tests, commodity production with 62 recipes)
14. ✅ Complete all 22 structure energy routing tests

### Short Term (Next 2 Weeks)
15. ☐ Begin power creep ability handlers (highest-value abilities first)

### Medium Term (Next Month)
16. ☐ Complete all power creep ability handlers

### Long Term
17. ☐ E7 parity validation (lockstep testing vs Node.js engine)

---

## Test Coverage Summary

| Handler | Tests Written | Tests Passing | Deferred | Coverage |
|---------|---------------|---------------|----------|----------|
| Movement | 25 | 25 | 0 | ✅ Complete |
| Spawn | 18 | 18 | 0 | ✅ Complete |
| Build/Repair | 12 | 12 | 0 | ✅ Complete |
| Harvest | 15 | 15 | 0 | ✅ Complete |
| Tower | 10 | 10 | 0 | ✅ Complete |
| **Resource I/O** | **31** | **31** | **0** | ✅ **Complete** |
| **Controller** | **12** | **12** | **0** | ✅ **Complete** |
| **Lab** | **24** | **24** | **0** | ✅ **Complete** |
| **Link** | **8** | **8** | **0** | ✅ **Complete** |
| **Power Spawn** | **6** | **6** | **0** | ✅ **Complete** |
| **Factory** | **8** | **8** | **0** | ✅ **Complete** |
| Power Abilities | 0 | 0 | 0 | ☐ Not started |

**Overall E2.3 Progress:** ~95% complete (10/11 major handler families implemented, only power abilities remaining)

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`
- **E5 Plan (Blockers):** `docs/engine/e5-plan.md` - Lists E2.3 features blocked by E5, implementation order after E5 Phase 1/2 complete

---

**Last Updated:** January 21, 2026 (Structure Energy Routing complete: 22/22 tests passing - Link, PowerSpawn, Factory)
