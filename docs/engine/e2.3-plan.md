# E2.3 – Room Processor Execution Plan

Status: updated January 16, 2026. This file tracks the granular work required to finish **E2.3 – “Wire engine consumption”** and its dependencies. It supplements `docs/engine/data-model.md` (data contracts) and `src/ScreepsDotNet.Engine/AGENT.md` (high-level milestones).

## What’s Done

- **Driver contracts exposed:** Room/intent snapshots now flow through typed DTOs (`RoomSnapshot`, `RoomObjectSnapshot`, `IntentEnvelope`, etc.). The engine never touches Mongo documents directly.
- **Spawn pipeline:** `SpawnIntentStep` uses helper services for parsing/energy charging/state reading, inserts placeholder creeps, and routes recycle deaths through `ICreepDeathProcessor`.
- **Action-log plumbing:** We now have typed DTOs (`RoomObjectActionLogSnapshot/Patch`) plus mapper support, so steps can emit `healed`, `die`, etc., without raw BSON fiddling.
- **Stats sink integration:** `RoomProcessor` instantiates a `RoomStatsSink` from the driver’s `IHistoryService`. All spawn/recycle paths, the energy charger, and the creep-death processor write to `context.Stats`, ensuring the legacy `stats.inc(...)` metrics are captured in the driver’s room stats updater.
- **Tower intents:** Managed `TowerIntentStep` handles `attack`, `heal`, and `repair`, including range falloff, rampart targeting, stat increments, and unit tests.

## Requirements & Dependency Chain

### 1. Action-log DTO/Patch Plumbing (Plan step 4 prerequisite) ✅
- Add typed action-log fields to the contracts, mapper, and mutation payload so any step can emit `healed`, `attack`, etc.
- This unblocks spawn/tower handlers from touching `_actionLog` directly and lets tests assert the new typed shape.

### 2. Action-log + Stats Integration inside SpawnIntentStep (Plan step 3) ✅
- Update `SpawnIntentStep` to populate the appropriate action-log entries (`healed`, `die`) and increment the richer stats counters (`spawnsRenew`, `spawnsRecycle`, `spawnsCreate`, `tombstonesCreated`).
- Ensure the new `RoomStatsSink` forwards these counters through the driver’s history service so telemetry doesn’t require later edits.

### 3. Finish Create/Renew/Recycle Parity Checks & Tests (Plan step 4) ✅
- Expand unit tests to cover the new action-log patches and stat increments.
- Update AGENT/docs (done in `docs/engine/data-model.md` and this file) to describe the spawn pipeline and shared constants so future sessions pick up the contracts.

### 4. Hook Additional Intent Processors into the Stats Sink (In Progress)
1. **Towers** – ✅ `TowerIntentStep` now deducts energy, applies damage/healing/repairs, and records stats (`energyConstruction` for repairs).  
2. **Creep Repair/Build** – ☐ Port the legacy `_repair`/`build` handlers:
   - Recompute repair/build power (including boosts) and apply HP/progress deltas.
   - Deduct energy from the creep, emit `context.Stats.IncrementEnergyConstruction(...)`, and insert finished structures with accurate base stats (hits, store capacities, decay timers).
   - Share structure blueprint helpers so both build completions and future structure-related steps can reuse them.
3. **Harvesting** – ☐ Port the harvest handler:
   - Support sources, minerals (with extractor cooldown), and deposits.
   - Update creep stores, handle overflow drops, and call `context.Stats.IncrementEnergyHarvested(...)`.

### 5. Telemetry Export Enhancements (Pending)
1. Extend the driver’s history/telemetry listeners to surface the new spawn/tombstone counters (`spawnsCreate`, `spawnsRecycle`, `tombstonesCreated`) if downstream observability expects them.
2. Once additional stats (repair/build/harvest) land, verify `RoomStatsUpdater` payloads include them so existing dashboards remain accurate.

### 6. Death Processor Coverage (Ongoing)
1. Ensure every lethal path (combat resolution ✅, tower attack ✅, recycle ✅) routes through `ICreepDeathProcessor`.
2. When we port movement crash/lifecycle expiration handlers, have them call the processor so drops/tombstones/stats stay centralized.

### 7. Remaining Legacy Handler Ports
1. **Tower attack/heal/repair** – ✅ Completed (`TowerIntentStep`).
2. **Creep repair/build** – ☐ See section 4.2 above.
3. **Harvest (sources/minerals/deposits)** – ☐ See section 4.3 above.
4. For every ported step, mirror the legacy `stats.inc(...)` call by invoking the appropriate `context.Stats` method and add unit tests covering both the functional mutation and the stat increment.

## Next Actions
1. Introduce shared structure/boost metadata so the upcoming repair/build handlers can insert finished structures with correct stats (hits, store capacity, decay data).
2. Port the creep repair/build logic using that metadata, including tests.
3. Follow up with the harvest handler and expanded telemetry coverage.
