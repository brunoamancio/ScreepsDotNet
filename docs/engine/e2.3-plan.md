# E2.3 ‚Äì Room Processor Handler Backlog

**Status:** Updated January 20, 2026

This document tracks the remaining intent handlers needed to complete E2.3 ("Wire engine consumption"). Once all handlers are ported from the Node.js engine, the .NET engine will be feature-complete for single-room simulation.

---

## Completed Handlers ‚úÖ

The following intent handlers are fully implemented and tested:

### Core Creep Actions
- ‚úÖ **Movement** - `MovementIntentStep` (includes crashes, pull chains, inter-room transfers, portal transfers)
- ‚úÖ **Spawning** - `SpawnIntentStep` (create, renew, recycle with stats/tombstones)
- ‚úÖ **Lifecycle** - `CreepLifecycleStep` (TTL expiration, zero-hit cleanup, user-summoned despawn)
- ‚úÖ **Build/Repair** - `CreepBuildRepairStep` (construction sites, structure repairs with blueprint integration)
- ‚úÖ **Harvesting** - `HarvestIntentStep` (sources, minerals, deposits with overflow drops)

### Structure Actions
- ‚úÖ **Towers** - `TowerIntentStep` (attack, heal, repair with range falloff)

### Resource I/O ‚úÖ
- ‚úÖ **Transfer/Withdraw/Pickup/Drop** - `ResourceTransferIntentStep` (31/31 tests, lab capacity tracking, power effects)

### Core Controller Actions ‚úÖ
- ‚úÖ **Controller** - `ControllerIntentStep` (12/12 tests, upgrade, reserve, attack with level transitions)

### Global/Power Creep Handlers
- ‚úÖ **Power Creep Lifecycle** - `PowerCreepIntentStep` (create, delete, rename, suicide, spawn, upgrade)
- ‚úÖ **Market** - `MarketIntentStep` (orders, deals, terminal sends, NPC maintenance)
- ‚úÖ **Inter-Room Transfers** - `InterRoomTransferStep` (edge exits, portal transfers, room activations)

### Infrastructure
- ‚úÖ **Stats/Telemetry** - `RoomStatsSink`, `RoomStatsPipeline`, `GlobalMutationWriter`
- ‚úÖ **Death Processing** - `ICreepDeathProcessor` (drops, tombstones, stats centralized)
- ‚úÖ **Blueprint System** - `StructureBlueprintRegistry` (structure metadata, decay timers, capacities)
- ‚úÖ **Driver Contracts** - All DTOs, mappers, and mutation payloads in place

---

## Remaining Handlers ‚òê

The following handlers must be implemented to complete E2.3:

### 1. Lab Reactions & Boosts (High Priority)
**Ready to implement** - Lab capacity tracking complete (`StoreCapacityResource` implemented)

- ‚òê `LabIntentStep` to handle:
  - `runReaction` - Consume reagents, produce compounds, set cooldown
  - `boostCreep` - Apply boost effects, consume minerals, update creep body parts

**Estimated effort:** 3-4 days
**Tests needed:** ~15 tests (reactions, reagent validation, cooldowns, boost application, mineral consumption)

**Remaining prerequisites:**
- Add `BoostEffect` fields to `RoomObjectSnapshot` (creep body parts)

### 2. Structure Energy Routing (Medium Priority)

- ‚òê `LinkIntentStep` - Energy transfers between links with cooldowns
- ‚òê `FactoryIntentStep` - Commodity production with cooldowns/reagents
- ‚òê `PowerSpawnIntentStep` - Process power into ops

**Estimated effort:** 4-5 days
**Tests needed:** ~20 tests total

### 3. Power Creep Abilities (Low Priority)
**Ready to implement** - Power effect types complete (`PowerEffectTypes` constants implemented)

- ‚òê `PowerCreepAbilityStep` to handle 19 power abilities:
  - `generateOps`, `operateSpawn`, `operateTower`, `operateStorage`, etc.
  - Each ability has unique validation, cooldowns, ranges, and effects

**Estimated effort:** 7-10 days
**Tests needed:** ~40+ tests (2-3 per ability)

**Remaining prerequisites:**
- Add effect duration/magnitude tracking to `RoomObjectSnapshot`
- Implement power effect decay logic

---

---

## Known Limitations / Deferred Features

The following features were intentionally deferred from Resource I/O implementation:

### Event Emission (Deferred - Non-Parity-Critical)
**Impact:** Low - Event logs are used for replays/debugging, not core simulation
**Parity Status:** NOT required for E7 parity validation

Transfer and withdraw operations currently do not emit `EVENT_TRANSFER` events to the event log. The Node.js engine emits these for replay visualization:

```javascript
// Node.js transfer.js line 58:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: source._id,
    data: {targetId: target._id, resourceType: resourceType, amount}
});

// Node.js withdraw.js line 59:
eventLog.push({
    event: C.EVENT_TRANSFER,
    objectId: target._id,  // Note: reversed - target is source
    data: {targetId: object._id, resourceType: intent.resourceType, amount}
});
```

**Why not parity-critical:**
- Event logs do NOT affect simulation correctness (verified: no game logic consumes EVENT_TRANSFER)
- Only used for replay visualization in the Screeps client
- Can be implemented post-MVP without affecting gameplay

**What's needed (when implemented):**
1. Add event log infrastructure to `RoomProcessorContext`
2. Implement `RecordTransferEvent(sourceId, targetId, resourceType, amount)` method
3. Call from `ProcessTransfer` (creep ‚Üí target) and `ProcessWithdraw` (target ‚Üí creep, reversed)
4. Extend `RoomIntentEventLogStep` to serialize transfer events to event log payload
5. Implement similar event emission for ALL intent handlers (attack, heal, build, harvest, upgrade, etc.)

**Note:** Event log implementation is a cross-cutting concern affecting all handlers, not just Resource I/O. Should be implemented holistically once event log infrastructure is in place.

## Deferred Features - Comprehensive Complexity Ranking

Across ALL implemented handlers (Resource I/O + Controller Intents), sorted by implementation complexity:

| Rank | Feature | Handler | Complexity | Effort | Parity? | Status | Quick Win? |
|------|---------|---------|-----------|--------|---------|--------|------------|
| ü•á 1 | **XML Documentation** | Resource I/O | TRIVIAL | 30 min | ‚ùå NO | ‚úÖ **COMPLETE** | ‚úÖ **YES** |
| ü•à 2 | **SafeMode available** | Controller | LOW | 1-2 hours | ‚úÖ YES | ‚úÖ **COMPLETE** | ‚úÖ **YES** |
| ü•â 3 | **Boost effects** | Controller | LOW-MEDIUM | 3-4 hours | ‚úÖ YES | ‚úÖ **COMPLETE** | ‚úÖ **YES** |
| 4 | **Event log (transfer)** | Resource I/O | MEDIUM | 1-2 days | ‚ùå NO | ‚òê Deferred | ‚ùå Cross-cutting |
| 5 | **Event log (upgrade)** | Controller | MEDIUM | Part of #4 | ‚ùå NO | ‚òê Deferred | ‚ùå Cross-cutting |
| 6 | **User GCL updates** | Controller | MEDIUM-HIGH | 1-2 days | ‚úÖ YES | ‚òê Blocked | ‚ùå Blocked |
| 7 | **Notifications** | Controller | HIGH | 3-5 days | ‚ùå NO | ‚òê Deferred | ‚ùå New system |

### ‚úÖ Quick Wins Complete! (January 20, 2026)
**Result:** All 3 quick wins implemented successfully in ~5 hours
**Parity Status:** 2 of 3 parity-blocking features resolved! ‚úÖ

### Remaining Parity Blocker:
- **User GCL updates** - Blocked by E5 (Global Systems) implementation, requires architectural decisions about global mutation batching

### XML Documentation (Deferred)
**Impact:** Low - Code is readable without XML docs, can add incrementally

Public methods in `ResourceTransferIntentStep` do not have XML documentation comments. Private validation/mutation helpers are well-named and self-documenting.

**What's needed:**
- Add `<summary>`, `<param>`, `<returns>` tags to public methods
- Document complex validation logic (rampart blocking, lab capacity tracking)

**Note:** This is standard tech debt that can be addressed during maintenance cycles.

### Controller Intents (Deferred - PARITY-BLOCKING)
**Impact:** HIGH - Required for E7 parity validation

The following features were deferred from the initial ControllerIntentStep implementation but **ARE required for legacy-parity** (verified against Node.js `upgradeController.js`):

#### Parity-Critical (MUST implement before E7):
1. **User GCL updates** - Node.js calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade (line 80-82)
   - **Why deferred:** Requires `IGlobalMutationWriter` with `IncrementUserGcl(userId, amount)` method
   - **Schema ready:** `UserState` already has GCL field
   - **Blocking:** E5 (Global Systems) must implement global user mutations first

2. **SafeMode available increment** - Node.js increments `target.safeModeAvailable` on level-up (line 73)
   - **Why deferred:** Requires adding `SafeModeAvailable` field to `RoomObjectSnapshot` and `RoomObjectPatchPayload`
   - **Schema change needed:** Add `int? SafeModeAvailable` (currently only `SafeMode` active timer exists)
   - **Blocking:** Schema update + patch mapper update + test updates

3. **Boost effects** - Node.js calculates `boostedEffect` using WORK part boosts (lines 31-53), affects progress AND GCL
   - **Why deferred:** Requires boost constants (`C.BOOSTS[WORK][boostType].upgradeController`) and calculation logic
   - **Schema ready:** `CreepBodyPartSnapshot.Boost` field already exists
   - **Blocking:** Boost system constants + calculation helpers

#### Parity-Desired (not simulation-critical):
4. **Level-up notifications** - Node.js calls `driver.sendNotification(...)` on level-up (line 69)
   - **Why deferred:** Requires notification system
   - **Impact:** User experience only, doesn't affect simulation correctness

5. **Event log emission** - Node.js emits `EVENT_UPGRADE_CONTROLLER` with amount/energySpent (lines 101-103)
   - **Why deferred:** Requires event log infrastructure
   - **Impact:** Replay/visualization only, doesn't affect simulation correctness

**E7 Requirements:** Items 1-3 MUST be implemented before parity validation. Items 4-5 can be deferred to post-MVP.

#### Complexity Analysis (Easiest ‚Üí Hardest):

| Feature | Complexity | Effort | Parity-Blocking? | Quick Win? |
|---------|-----------|--------|------------------|------------|
| **SafeMode available increment** | LOW | 1-2 hours | ‚úÖ YES | ‚úÖ **Quick win** |
| **Boost effects (upgrade only)** | LOW-MEDIUM | 3-4 hours | ‚úÖ YES | ‚úÖ **Quick win** |
| **User GCL updates** | MEDIUM-HIGH | 1-2 days | ‚úÖ YES | ‚ùå Blocked by E5 |
| **Event log (upgrade)** | MEDIUM | Part of holistic event system | ‚ùå NO | ‚ùå Cross-cutting |
| **Level-up notifications** | HIGH | 3-5 days (new system) | ‚ùå NO | ‚ùå New infrastructure |

**Recommended next steps:**
1. **Immediate (< 6 hours):** Implement SafeMode + Boost effects ‚Üí 2 of 3 parity blockers resolved
2. **Short-term (after E5):** User GCL updates ‚Üí Last parity blocker resolved
3. **Long-term:** Event logs and notifications as holistic infrastructure work

**Tracking:** See `.claude/plans/twinkling-roaming-lampson.md` completion summary

---

## Next Steps (Priority Order)

### ‚úÖ Completed (January 19-20, 2026)
1. ‚úÖ Complete Resource I/O handler (transfer, withdraw, pickup, drop)
2. ‚úÖ Add infrastructure for lab capacity tracking and power effects
3. ‚úÖ Complete all 31 Resource I/O tests
4. ‚úÖ Implement `ControllerIntentStep` (upgrade, reserve, attack)
5. ‚úÖ Complete all 12 Controller intent tests (level transitions, reservation, attacks)

### Short Term (Next 2 Weeks)
6. ‚òê Implement basic lab reactions (without boost support initially)
7. ‚òê Add boost creep functionality to labs

### Medium Term (Next Month)
8. ‚òê Implement structure energy routing (links, factory, power spawn)
9. ‚òê Begin power creep ability handlers (highest-value abilities first)

### Long Term
10. ‚òê Complete all power creep ability handlers
11. ‚òê E7 parity validation (lockstep testing vs Node.js engine)

---

## Test Coverage Summary

| Handler | Tests Written | Tests Passing | Deferred | Coverage |
|---------|---------------|---------------|----------|----------|
| Movement | 25 | 25 | 0 | ‚úÖ Complete |
| Spawn | 18 | 18 | 0 | ‚úÖ Complete |
| Build/Repair | 12 | 12 | 0 | ‚úÖ Complete |
| Harvest | 15 | 15 | 0 | ‚úÖ Complete |
| Tower | 10 | 10 | 0 | ‚úÖ Complete |
| **Resource I/O** | **31** | **31** | **0** | ‚úÖ **Complete** |
| **Controller** | **12** | **12** | **0** | ‚úÖ **Complete** |
| Lab | 0 | 0 | 0 | ‚òê Not started |
| Power Abilities | 0 | 0 | 0 | ‚òê Not started |

**Overall E2.3 Progress:** ~80% complete (9/10 major handler families implemented)

---

## References

- **Node.js Engine:** `/home/th3b0y/screeps-rewrite/ScreepsNodeJs/engine/src/processor/intents/`
- **Implementation Plan:** `.claude/plans/agile-churning-barto-agent-a7b1b45.md`
- **Driver Contracts:** `src/ScreepsDotNet.Driver/Contracts/`
- **Engine CLAUDE.md:** `src/ScreepsDotNet.Engine/CLAUDE.md`

---

**Last Updated:** January 20, 2026 (Quick wins completed)
