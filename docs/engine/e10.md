# E10: Full Parity Test Coverage

**Status:** ‚úÖ Phase 3 Complete, Phase 4 Pending (CI/CD)
**Current State:** 95 parity tests, 91 test methods, 100% coverage, 509 Engine tests passing
**Last Updated:** January 23, 2026

---

## Summary

**Completed:**
- ‚úÖ 95 JSON fixtures covering all E1-E6 features (317% of 25-30 target)
- ‚úÖ Single Theory test with auto-discovery (adding tests = adding JSON files)
- ‚úÖ 91/91 test methods passing (100% coverage)
- ‚úÖ 11 documented architectural differences (4 intentional optimizations/decisions)
- ‚úÖ All P0 systems complete (Combat, Build/Repair, Movement, Controller, Harvest, Structures)

**Remaining:**
- ‚è≥ Phase 4: CI/CD automation (GitHub Actions workflow, 2-3 hours)

---

## Remaining Work

### Phase 4: CI/CD Automation (Pending)

**Goal:** Automate parity test execution in GitHub Actions

**Tasks:**
1. Create `.github/workflows/parity-tests.yml`
2. Set up MongoDB container in CI
3. Install Node.js 10.13.0-12.x for harness
4. Clone official Screeps repos (engine, driver, common)
5. Run parity tests on every commit
6. Report divergences as test failures

**Estimated:** 2-3 hours

**Blockers:** None

---

## Architectural Decisions (Intentional Divergences)

These are **intentional optimizations** where .NET differs from Node.js for performance or correctness:

### 1. Timer Representation (1 fixture)
- **Node.js:** Countdown timers decrement every tick ‚Üí patches every tick
- **.NET:** Absolute timestamps ‚Üí only patches when timer expires
- **Benefit:** Eliminates ~300 unnecessary DB writes per source per regeneration cycle
- **Fixture:** `harvest_basic.json`

### 2. JavaScript Type Coercion Bug (1 fixture)
- **Node.js BUG:** Empty store `{}` bypasses validation (`undefined <= 0` is `false`)
- **.NET:** Correctly validates empty store as zero energy
- **Benefit:** Correct validation behavior
- **Fixture:** `edgecase_upgrade_no_energy.json`

### 3. ActionLog Optimization (9 fixtures)
- **Node.js:** Patches ALL touched objects every tick (even validation failures)
- **.NET:** Only patches objects with actual state changes
- **Benefit:** 30-50% fewer DB writes
- **Client Impact:** Minimal (clients should validate locally)
- **Fixtures:** `edgecase_transfer_zero`, `validation_transfer_out_of_range`, `validation_transfer_invalid_target`, `edgecase_ttl_one`, `pull_out_of_range`, `movement_without_move_part`, `lab_boost_creep`, `link_source_empty`, `build_without_work`

### Implementation Pattern
```csharp
// Exclude known divergences from common test
private static readonly HashSet<string> FixturesWithKnownDivergences = new(StringComparer.OrdinalIgnoreCase)
{
    "harvest_basic.json",  // Timer representation
    "edgecase_upgrade_no_energy.json",  // JS bug
    // ... 9 ActionLog optimization fixtures
};

// Dedicated test validates ONLY expected divergence exists
[Fact]
public async Task HarvestBasic_HasKnownTimerDivergence_AllOtherBehaviorMatches()
{
    // Run both engines, compare outputs
    // Assert: ONLY timer divergence exists, fail if any unexpected divergences
}
```

---

## Deferred Features

### Stats Comparison (Disabled)
- **Status:** Disabled in `ParityComparator.cs` line 28
- **Reason:** Node.js harness doesn't capture stats yet
- **Re-enablement:** Update Node.js harness to serialize stats ‚Üí uncomment comparator code
- **Affected:** Test assertions in `ParityComparatorTests.cs` (lines 92, 103-108, 184, 223, 226)

### Observer Mechanics
- **Status:** Not implemented (E9 dependency)
- **Reason:** Observer requires NPC AI systems
- **When:** After E9 completion

### Terminal.send Global
- **Status:** Deferred
- **Reason:** Requires GlobalParityTestRunner (multi-room orchestration)
- **When:** When cross-room mechanics become priority

---

## Future Improvements

### Test Infrastructure
1. **GlobalParityTestRunner** (optional, 8-16 hours)
   - Cross-room/global processor testing
   - Currently: Sufficient coverage from unit tests (`MarketIntentStepTests`, `PowerCreepIntentStepTests`)
   - When to reconsider: Production divergence detected, complex new global features, certification needs

2. **Additional Mechanics Fixtures** (25+ scenarios)
   - Combat edge cases (simultaneous attacks, overkill, friendly fire)
   - Movement complex scenarios (fatigue, swamp, blocked paths)
   - Build/repair validation edge cases
   - Spawn/nuker/factory additional coverage

3. **Action Log Comparison**
   - Currently: Only final state compared
   - Enhancement: Validate action logs match (less critical, final state is ground truth)

### Performance Optimizations
1. **Fixture Caching** - Cache parsed JSON fixtures (reduce I/O)
2. **Parallel Test Execution** - Run independent fixtures in parallel
3. **Incremental Comparison** - Skip unchanged objects in comparison

### Documentation
1. **Divergence Playbook** - When to accept vs fix divergences
2. **Fixture Authoring Guide** - How to write effective parity fixtures
3. **CI/CD Runbook** - Troubleshooting parity test failures in CI

---

## Key Files

**Tests:**
- `ScreepsDotNet.Engine.Tests/Parity/ParityTests.cs` - Main parity test (auto-discovery)
- `ScreepsDotNet.Engine.Tests/Parity/Fixtures/*.json` - 95 JSON fixtures

**Infrastructure:**
- `ScreepsDotNet.Engine.Tests/Parity/JsonFixtureLoader.cs` - Fixture deserialization
- `ScreepsDotNet.Engine.Tests/Parity/Comparison/ParityComparator.cs` - Output comparison
- `ScreepsDotNet.Engine.Tests/Parity/Comparison/DivergenceReporter.cs` - Divergence formatting

**Node.js Harness:**
- `tools/parity-harness/CLAUDE.md` - Harness documentation
- `tools/parity-harness/src/` - Node.js test runner

**Configuration:**
- `tools/parity-harness/versions.json` - Official Screeps repo versions
- `docs/engine/mongodb-parity-setup.md` - Setup guide

---

## Workflow

### Adding New Parity Tests
1. Create JSON fixture in `ScreepsDotNet.Engine.Tests/Parity/Fixtures/`
2. Run tests - auto-discovery picks up new fixture
3. If divergence found ‚Üí investigate:
   - **Bug in .NET?** Fix implementation
   - **Intentional optimization?** Add to `FixturesWithKnownDivergences` + dedicated test
   - **Node.js bug?** Document in dedicated test

### Handling Divergences
```bash
# 1. Run parity tests
dotnet test --filter Category=Parity

# 2. If failure, check divergence report
# Report shows exact field-by-field differences

# 3. Decide action:
#    - Fix .NET implementation (if bug)
#    - Document as optimization (if intentional)
#    - Report Node.js bug (if Node.js incorrect)

# 4. Add dedicated test if keeping divergence
# See "Architectural Decisions" section for pattern
```

### CI/CD Integration (Future)
```yaml
# .github/workflows/parity-tests.yml (TODO)
name: Parity Tests
on: [push, pull_request]
jobs:
  parity:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: '12.x'
      - name: Clone Screeps repos
        run: cd tools/parity-harness && node src/clone-repos.js
      - name: Run parity tests
        run: dotnet test --filter Category=Parity
```

---

## Success Metrics

**Current:**
- ‚úÖ 95/95 fixtures covered (100%)
- ‚úÖ 91/91 test methods passing (100%)
- ‚úÖ 509 Engine tests total (includes 91 parity)
- ‚úÖ 11 documented architectural differences
- ‚úÖ All E1-E6 features validated

**Remaining:**
- ‚è≥ CI/CD automated (Phase 4)
- üìã Additional mechanics fixtures (nice-to-have)
- üìã Stats comparison enabled (when Node.js harness updated)

---

## Cross-References

- **E7 Infrastructure:** `docs/engine/e7.md` (parity framework design)
- **Node.js Harness:** `tools/parity-harness/CLAUDE.md` (harness implementation)
- **MongoDB Setup:** `docs/engine/mongodb-parity-setup.md` (parity testing prerequisites)
- **E9 Dependency:** `docs/engine/e9.md` (NPC AI for observer mechanics)
- **Roadmap:** `docs/engine/roadmap.md` (E10 status tracking)
