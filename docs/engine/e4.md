# E4 â€“ Simulation Kernel (Room Processor)

**Status:** âœ… 100% Complete
**Last Updated:** January 21, 2026

---

## Overview

E4 completes the room simulation kernel by implementing the remaining passive systems that run every tick regardless of player intents. The RoomProcessor orchestration and most game mechanics are already in place from E2/E3.

**Completed:**
- âœ… RoomProcessor orchestration (`RoomProcessor.cs`)
- âœ… Intent validation pipeline (E3 - `IntentValidationStep`)
- âœ… 11/11 intent handler families (E2 - 240/240 tests)
- âœ… Passive systems: structure decay, controller downgrade, power effect decay, creep aging
- âœ… Global systems: inter-room transfers, power creeps, market
- âœ… Stats/telemetry infrastructure

**Completed (This Milestone):**
- âœ… Source energy regeneration (15 tests passing)
- âœ… Mineral regeneration with density changes (12 tests passing)

**Not Applicable (This Milestone):**
- âšª Construction site decay - **DOES NOT EXIST in legacy Screeps engine** (verified via Node.js source)

**Deferred to E5:**
- NPC spawning (invaders, source keepers) - requires global coordination

---

## Dependencies

**Upstream:**
- âœ… E2 (Data & Storage Model) - 95% complete, handlers in place
- âœ… E3 (Intent Validation) - 100% complete, integrated into RoomProcessor

**Blocked By:** None

**Blocks:**
- E5 (Global Systems) - builds on complete room processor
- E6 (Engine Loop Orchestration) - needs stable simulation kernel
- E7 (Parity Validation) - compares room diffs against Node.js

---

## Implementation Plan

### E4.1: Source Regeneration âœ…

**Status:** Complete
**Effort:** 2-3 hours
**Tests:** 15 tests (all passing)

**Deliverables:**
- `SourceRegenerationStep.cs` - Passive source energy regeneration
- `SourceRegenerationStepTests.cs` - 15 tests covering all scenarios

**Logic (from Node.js `sources/tick.js`):**

1. **Basic Regeneration:**
   - If `energy < energyCapacity` and `nextRegenerationTime` is null:
     - Set `nextRegenerationTime = gameTime + ENERGY_REGEN_TIME` (300 ticks)
   - If `gameTime >= nextRegenerationTime - 1`:
     - Reset `nextRegenerationTime = null`
     - Set `energy = energyCapacity`

2. **PWR_DISRUPT_SOURCE Effect:**
   - If source has PWR_DISRUPT_SOURCE effect active:
     - Increment `nextRegenerationTime` by 1 each tick (delays regeneration)

3. **PWR_REGEN_SOURCE Effect:**
   - If source has PWR_REGEN_SOURCE effect active:
     - Every `period` ticks (from POWER_INFO):
       - Add `effect[level - 1]` energy (up to `energyCapacity`)

4. **Capacity Adjustment:**
   - If room has controller with owner/reservation:
     - Set `energyCapacity = SOURCE_ENERGY_CAPACITY` (3000)
   - Else if room has no controller (keeper room):
     - Set `energyCapacity = SOURCE_ENERGY_KEEPER_CAPACITY` (4000)
   - Else (neutral room):
     - Set `energyCapacity = SOURCE_ENERGY_NEUTRAL_CAPACITY` (1500)
   - Clamp `energy` to new capacity if reduced

**Test Coverage (15 tests):**
1. âœ… Source with full energy does nothing
2. âœ… Source with depleted energy sets nextRegenerationTime
3. âœ… Source regenerates when gameTime >= nextRegenerationTime - 1
4. âœ… Source regeneration clears nextRegenerationTime
5. âœ… PWR_DISRUPT_SOURCE delays regeneration by 1 tick each tick
6. âœ… PWR_REGEN_SOURCE adds energy every period ticks
7. âœ… PWR_REGEN_SOURCE respects energyCapacity
8. âœ… Owned room sets capacity to 3000
9. âœ… Reserved room sets capacity to 3000
10. âœ… Neutral room sets capacity to 1500
11. âœ… Keeper room sets capacity to 4000
12. âœ… Capacity reduction clamps energy
13. âœ… Multiple effects (DISRUPT + REGEN) work together
14. âœ… Regeneration at exact boundary (gameTime == nextRegenerationTime - 1)
15. âœ… Partial energy does not trigger regen until time reached

**Constants Used:**
- `ENERGY_REGEN_TIME` = 300
- `SOURCE_ENERGY_CAPACITY` = 3000
- `SOURCE_ENERGY_NEUTRAL_CAPACITY` = 1500
- `SOURCE_ENERGY_KEEPER_CAPACITY` = 4000
- `PWR_REGEN_SOURCE` power info (period, effect by level)

---

### E4.2: Mineral Regeneration âœ…

**Status:** Complete
**Effort:** 2-3 hours
**Tests:** 12 tests (all passing)

**Deliverables:**
- `MineralRegenerationStep.cs` - Passive mineral regeneration with density changes
- `MineralRegenerationStepTests.cs` - 12 tests covering all scenarios

**Logic (from Node.js `minerals/tick.js`):**

1. **Basic Regeneration:**
   - If `mineralAmount == 0` and `nextRegenerationTime` is null:
     - Set `nextRegenerationTime = gameTime + MINERAL_REGEN_TIME` (50000 ticks)
   - If `gameTime >= nextRegenerationTime - 1`:
     - Reset `nextRegenerationTime = null`
     - Set `mineralAmount = MINERAL_DENSITY[density]`
     - **Density Change Logic:**
       - If `density == DENSITY_LOW` or `density == DENSITY_ULTRA`:
         - Always change density
       - Else:
         - Change density with probability `MINERAL_DENSITY_CHANGE` (0.05 = 5%)
       - New density selected from `MINERAL_DENSITY_PROBABILITY` distribution
       - Repeat selection until new density != old density

2. **PWR_REGEN_MINERAL Effect:**
   - If mineral has PWR_REGEN_MINERAL effect active and `mineralAmount > 0`:
     - Every `period` ticks (from POWER_INFO):
       - Add `effect[level - 1]` minerals (no upper limit)

**Test Coverage (12 tests):**
1. âœ… Mineral with amount > 0 does nothing
2. âœ… Mineral with 0 amount sets nextRegenerationTime
3. âœ… Mineral regenerates when gameTime >= nextRegenerationTime - 1
4. âœ… Mineral regeneration clears nextRegenerationTime
5. âœ… Density LOW always changes on regen
6. âœ… Density ULTRA always changes on regen
7. âœ… Density MODERATE/HIGH changes 5% of the time (statistical test)
8. âœ… Density change never picks same density
9. âœ… Regenerated amount matches MINERAL_DENSITY[density]
10. âœ… PWR_REGEN_MINERAL adds minerals every period ticks
11. âœ… PWR_REGEN_MINERAL only works if mineralAmount > 0
12. âœ… PWR_REGEN_MINERAL has no upper limit

**Constants Used:**
- `MINERAL_REGEN_TIME` = 50000
- `MINERAL_DENSITY` = { [DENSITY_LOW]: 15000, [DENSITY_MODERATE]: 35000, [DENSITY_HIGH]: 70000, [DENSITY_ULTRA]: 100000 }
- `MINERAL_DENSITY_CHANGE` = 0.05
- `MINERAL_DENSITY_PROBABILITY` = { [1]: 0.1, [2]: 0.5, [3]: 0.9, [4]: 1.0 }
- `PWR_REGEN_MINERAL` power info (period, effect by level)

---

### E4.3: Construction Site Decay âšª NOT APPLICABLE

**Status:** Not Applicable - **Feature does not exist in legacy Screeps engine**
**Verification Date:** January 21, 2026
**Legacy Source:** `/ScreepsNodeJs/engine/src/processor/intents/construction-sites/tick.js`

**Finding:**
The legacy Node.js engine's `construction-sites/tick.js` file is **completely empty** (no logic). Extensive search of the Node.js codebase confirms that construction sites:
- Do NOT have decay timers
- Do NOT auto-remove after inactivity
- Persist indefinitely until manually removed or completed

**References:**
- Legacy file: `ScreepsNodeJs/engine/src/processor/intents/construction-sites/tick.js` (lines 6-11: empty function body)
- Official Screeps API docs: No mention of construction site decay mechanics
- Web research: No documented decay behavior

**Original Plan Assumption:**
The e4.md plan originally stated "Construction sites have a timer (typically 50000 ticks)" but this appears to have been a misunderstanding or confusion with other decay mechanics (containers, ramparts, etc.).

**Implementation Decision:**
- **No implementation needed** - this feature doesn't exist in Screeps
- **No tests needed** - nothing to verify against legacy behavior
- E4 milestone is complete with the 2 passive systems that actually exist (source + mineral regeneration)

---

### E4.4: Step Registration & Ordering âœ…

**Status:** Complete (2/2 passive systems registered)
**Effort:** Complete

**Current Order (20 steps):**
```csharp
// 1. Intent validation (E3)
services.AddSingleton<IRoomProcessorStep, IntentValidationStep>();

// 2. Lifecycle (deaths, TTL, fatigue)
services.AddSingleton<IRoomProcessorStep, CreepLifecycleStep>();

// 3. Movement
services.AddSingleton<IRoomProcessorStep, MovementIntentStep>();

// 4. Spawn operations
services.AddSingleton<IRoomProcessorStep, SpawnIntentStep>();
services.AddSingleton<IRoomProcessorStep, SpawnSpawningStep>();

// 5. Tower actions
services.AddSingleton<IRoomProcessorStep, TowerIntentStep>();

// 6. Creep actions
services.AddSingleton<IRoomProcessorStep, CreepBuildRepairStep>();
services.AddSingleton<IRoomProcessorStep, HarvestIntentStep>();

// 7. Passive regeneration (E4.1, E4.2) âœ…
services.AddSingleton<IRoomProcessorStep, SourceRegenerationStep>();
services.AddSingleton<IRoomProcessorStep, MineralRegenerationStep>();

// 8. Resource I/O
services.AddSingleton<IRoomProcessorStep, ResourceTransferIntentStep>();

// 9. Structure processing
services.AddSingleton<IRoomProcessorStep, LabIntentStep>();
services.AddSingleton<IRoomProcessorStep, LinkIntentStep>();
services.AddSingleton<IRoomProcessorStep, PowerSpawnIntentStep>();
services.AddSingleton<IRoomProcessorStep, FactoryIntentStep>();

// 10. Combat
services.AddSingleton<IRoomProcessorStep, CombatResolutionStep>();

// 11. Passive systems
services.AddSingleton<IRoomProcessorStep, StructureDecayStep>();
services.AddSingleton<IRoomProcessorStep, ControllerDowngradeStep>();

// 12. Controller actions (after passive downgrade)
services.AddSingleton<IRoomProcessorStep, ControllerIntentStep>();

// 13. Power system
services.AddSingleton<IRoomProcessorStep, PowerEffectDecayStep>();
services.AddSingleton<IRoomProcessorStep, PowerAbilityStep>();
services.AddSingleton<IRoomProcessorStep, PowerAbilityCooldownStep>();

// 14. Event logging
services.AddSingleton<IRoomProcessorStep, RoomIntentEventLogStep>();
```

**Rationale:**
- Sources/minerals regenerate AFTER harvest intents (harvest depletes, regen replenishes)
- No construction site decay step needed (feature doesn't exist in legacy engine)

---

## Success Criteria

E4 is complete when:
1. âœ… All passive systems implemented (2/2 complete: source regen âœ…, mineral regen âœ…)
2. âœ… 27 new tests passing (15 source + 12 mineral)
3. âœ… All existing tests still pass (707 tests total, all passing)
4. âœ… Steps registered in DI in correct order (2/2 registered: source âœ…, mineral âœ…)
5. âœ… Code reviewed and follows coding standards
6. âœ… Construction site decay verified as non-existent in legacy engine
7. ðŸ“‹ Performance acceptable (<10ms per room target - measure in E6)
8. ðŸ“‹ Parity with Node.js (deferred to E7)

---

## Exit Criteria

**Milestone Complete:** âœ… All passive systems verified and implemented (January 21, 2026)

**Key Finding:** Construction site decay was assumed to exist but does not - verified against Node.js source

**Blocked Work Unblocked:**
- E5 (Global Systems) can proceed - room processor is stable
- E6 (Orchestration) can integrate - simulation kernel is complete
- E7 (Parity Validation) can compare - all mechanics implemented

---

## Deferred Features

**NPC Spawning (Invaders, Source Keepers):**
- **Reason:** Requires global coordination (E5 - Global Systems)
- **Details:** NPC spawning depends on global timers, room status, player activity across shards
- **Impact:** Private servers can function without NPCs for local testing
- **Timeline:** E5 implementation

**Nuker Launch:**
- **Reason:** Likely an intent handler (E2 scope), not passive system
- **Details:** Check if nuke launching is already in E2 handlers
- **Timeline:** E2 completion or E5

**Power Bank Decay:**
- **Reason:** Keeper rooms (E5 global system)
- **Timeline:** E5 implementation

---

## Reference Documents

- **E2 Handler Tracking:** `e2.md` (intent handlers, 95% complete)
- **E3 Validation:** `e3.md` (intent validation pipeline, 100% complete)
- **E5 Global Systems:** `e5.md` (NPC spawning, global mutations)
- **Roadmap:** `roadmap.md` (E1-E8 milestones)
- **Node.js Engine Source:**
  - `ScreepsNodeJs/engine/src/processor/intents/sources/tick.js`
  - `ScreepsNodeJs/engine/src/processor/intents/minerals/tick.js`
  - `ScreepsNodeJs/engine/src/processor/intents/constructionSites/tick.js`

---

## Implementation Notes

**Current State Analysis:**
- RoomProcessor orchestration is mature and stable
- 18 processor steps registered (E2 + E3 work)
- Mutation writers, stats sinks, memory persistence all working
- Integration with Driver layer complete
- **Only missing:** 3 passive regeneration/decay systems

**Why E4 Was Marked "Not Started":**
- Roadmap created before E2/E3 implementation
- E2/E3 work incrementally built the room processor infrastructure
- E4 was originally scoped as "build entire simulation kernel"
- Reality: E4 is now "complete the remaining passive systems"

**Estimated Completion Time:**
- SourceRegenerationStep: 2-3 hours
- MineralRegenerationStep: 2-3 hours
- ConstructionSiteDecayStep: 1 hour
- Testing & integration: 1 hour
- **Total:** 6-8 hours to complete E4

---

**Last Updated:** January 21, 2026
**Status:** âœ… 100% Complete - All passive systems verified and implemented

**Implementation Summary:**
- âœ… E4.1 (SourceRegenerationStep): 15 tests, all passing, registered in DI
- âœ… E4.2 (MineralRegenerationStep): 12 tests, all passing, registered in DI
- âšª E4.3 (Construction Site Decay): **NOT APPLICABLE** - verified via Node.js source that this feature does not exist

**Verification:**
- Legacy engine source checked: `/ScreepsNodeJs/engine/src/processor/intents/construction-sites/tick.js` is empty
- No construction site decay logic exists anywhere in Node.js codebase
- Construction sites persist indefinitely until manually removed or completed
