# E5 ‚Äì Global Systems

**Status:** Not Started (Placeholder for E2.3 cross-references)

This document tracks the E5 "Global Systems" work, which includes global mutations (user GCL, credits, resources), power effect tracking, market operations, NPC spawns, and shard messaging.

---

## Purpose

E5 implements global state mutations that affect users, shards, and cross-room systems. This is distinct from E2.3's room-level intent handlers.

**Key differences from E2.3:**
- **E2.3:** Room-level mutations (objects, room info, action logs)
- **E5:** Global-level mutations (user stats, global resources, cross-room effects)

---

## Blocked E2.3 Features

The following E2.3 features are **blocked** by E5 implementation and should be implemented **after** E5 global mutation infrastructure is in place:

### 1. User GCL Updates (Controller Intents)
**Blocking E2.3 Feature:** `ControllerIntentStep.ProcessUpgrade()` GCL accumulation
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Controller Intents (Deferred - PARITY-BLOCKING)"
**Parity Status:** ‚úÖ **PARITY-CRITICAL** (required for E7 validation)

**What's blocked:**
- Node.js calls `bulkUsers.inc(target.user, 'gcl', boostedEffect)` on **EVERY** upgrade
- Both boosted AND non-boosted GCL gains are blocked
- Affects controller progress ‚Üí user GCL progression

**What's needed from E5:**
1. Implement `IGlobalMutationWriter` interface with `IncrementUserGcl(userId, amount)` method
2. Add global mutation batching infrastructure (similar to room-level `IRoomMutationWriter`)
3. Wire global mutations into processor context
4. Flush global mutations to user documents at end of tick

**Implementation effort after E5:** 1-2 hours (just call `context.GlobalMutationWriter.IncrementUserGcl()`)

---

### 2. Boost Effects (GCL Component)
**Blocking E2.3 Feature:** `ControllerIntentStep.ProcessUpgrade()` boosted GCL gains
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Controller Intents (Deferred - PARITY-BLOCKING)"
**Parity Status:** ‚ö†Ô∏è **PARTIALLY COMPLETE** (controller progress done, GCL blocked)

**What's blocked:**
- Boost multipliers (GH: 1.5x, GH2O: 1.8x, XGH2O: 2.0x) apply to controller progress ‚úÖ **COMPLETE**
- Boost multipliers apply to GCL gains ‚ùå **BLOCKED** (same issue as #1)

**What's needed from E5:**
- Same infrastructure as #1 (IGlobalMutationWriter)

**Implementation effort after E5:** Included in #1 (same code path)

---

### 3. PWR_OPERATE_LAB Power Effect
~~**UNBLOCKED** - Completed in E2.3 (January 21, 2026)~~
**Status:** ‚úÖ **COMPLETE** - Power effect infrastructure implemented in E2.3
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Lab Reactions & Boosts"

**What was completed:**
- ‚úÖ Power effect tracking system (`PowerEffectDecayStep`, `PowerAbilityStep`)
- ‚úÖ Effect consumption in `LabIntentStep.ProcessRunReaction()`
- ‚úÖ Reaction amount boost: 5 + effect bonus (levels 1-5: 7/9/11/13/15)
- ‚úÖ 3 tests added (effect levels 1/3/5)

**Lesson learned:** Power effects are **room-local** (no global state), so they belonged in E2.3, not E5.

---

### 4. PWR_OPERATE_POWER Power Effect
~~**UNBLOCKED** - Completed in E2.3 (January 21, 2026)~~
**Status:** ‚úÖ **COMPLETE** - Power effect infrastructure implemented in E2.3
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Structure Energy Routing"

**What was completed:**
- ‚úÖ Effect consumption in `PowerSpawnIntentStep.ProcessPowerSpawn()`
- ‚úÖ Processing amount boost: 1 + effect bonus (levels 1-5: 2/3/4/5/6)
- ‚úÖ 3 tests added (effect levels 1/3/5)
- ‚úÖ PowerInfo Effect array added: [1, 2, 3, 4, 5]

---

### 5. PWR_OPERATE_FACTORY Power Effect
~~**UNBLOCKED** - Completed in E2.3 (January 21, 2026)~~
**Status:** ‚úÖ **COMPLETE** - Power effect infrastructure implemented in E2.3
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Structure Energy Routing"

**What was completed:**
- ‚úÖ Effect consumption in `FactoryIntentStep.ProcessProduce()`
- ‚úÖ Factory level boost for recipe gating: level + effect bonus (levels 1-5: +1/+2/+3/+4/+5)
- ‚úÖ 3 tests added (effect levels 1/3/5 allowing level-gated commodities)
- ‚úÖ PowerInfo Effect array added: [1, 2, 3, 4, 5]

---

### 6. PWR_GENERATE_OPS Power Ability
**Blocking E2.3 Feature:** `PowerAbilityStep` PWR_GENERATE_OPS ability
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Power Creep Abilities (Deferred)"
**Parity Status:** ‚úÖ **PARITY-CRITICAL** (required for E7 validation)

**What's blocked:**
- Power creeps can use `PWR_GENERATE_OPS` to generate ops from user's global power balance
- Node.js behavior (usePower.js lines 57-69): Adds ops to power creep store, drops overflow if exceeds capacity
- Requires tracking user's global power balance (incremented by power spawns, decremented by generateOps)

**What's needed from E5:**
1. Implement `IGlobalMutationWriter.IncrementUserPower(userId, amount)` method
2. Implement `IGlobalMutationWriter.DecrementUserPower(userId, amount)` method
3. Add user power balance field to global user mutations

**Implementation effort after E5:** 1-2 hours
- Add generateOps case to `PowerAbilityStep.ProcessUsePower` switch
- Calculate ops amount: `powerInfo.Effect[level - 1]` (levels 1-5: 1/2/4/6/8 ops)
- Deduct from user power balance: `context.GlobalMutationWriter.DecrementUserPower(creep.UserId, opsCost)`
- Add ops to power creep store, drop overflow if exceeds capacity
- 2 tests: valid use (ops added), overflow (drops created)

---

### 7. User Power Balance Updates (Power Spawn)
**Blocking E2.3 Feature:** `PowerSpawnIntentStep.ProcessPowerSpawn()` power balance tracking
**E2 Reference:** `docs/engine/e2.md` ‚Üí "Structure Energy Routing (Deferred Features)"
**Parity Status:** ‚úÖ **PARITY-CRITICAL** (required for E7 validation)

**What's blocked:**
- Power spawns should increment user's global power balance when processing power
- Node.js behavior: Calls `bulkUsers.inc(powerSpawn.user, 'power', amount)` on every power processing
- Currently power is consumed but user balance is not tracked

**What's needed from E5:**
- Same infrastructure as #6 (`IGlobalMutationWriter.IncrementUserPower`)

**Implementation effort after E5:** 30 minutes
- In `ProcessPowerSpawn`, call `context.GlobalMutationWriter.IncrementUserPower(powerSpawn.UserId, amount)`
- No new tests needed (existing tests cover power spawn processing)

---

## E4 Deferred Features

The following E4 features are **deferred** to E5 because they require global coordination, cross-room mechanics, or shard-wide timing that is beyond E4's room-level scope.

### 8. NPC Spawning (Invaders, Source Keepers)
**Deferred from:** E4 (Simulation Kernel - Room Processor)
**E4 Reference:** `docs/engine/e4.md` ‚Üí "Deferred Features"
**Parity Status:** ‚úÖ **PARITY-CRITICAL** (required for E7 validation)

**Why deferred:**
- Invader spawning depends on **global room status tracking** across the entire shard
- Source keeper spawning uses **global room timers** and player activity heuristics
- Spawning logic requires **cross-room coordination** (e.g., invader paths between rooms)
- Cannot be implemented at room-level in isolation

**What's needed from E5:**
1. Global room status tracking (player activity, room ownership changes)
2. Shard-wide NPC spawn timers
3. Cross-room pathfinding coordination for invader routes
4. Global NPC state management (invader goals, source keeper respawns)

**Implementation effort after E5:** 3-5 days
- Implement invader spawn logic (global timer + room status checks)
- Implement source keeper spawn logic (keeper room detection + respawn timing)
- Add NPC movement coordination (cross-room pathing)
- 10-15 tests covering spawn conditions, timing, and cross-room behavior

---

### 9. Power Bank Decay
**Deferred from:** E4 (Simulation Kernel - Room Processor)
**E4 Reference:** `docs/engine/e4.md` ‚Üí "Deferred Features"
**Parity Status:** ‚ö†Ô∏è **LOWER PRIORITY** (keeper room mechanic)

**Why deferred:**
- Power banks are part of **keeper room mechanics** (global room type)
- Decay timing is coordinated with source keeper spawning (see #8)
- Power bank spawning/despawning affects global power economy

**What's needed from E5:**
1. Keeper room detection and management (global room type tracking)
2. Power bank spawn/decay timers (coordinated with source keepers)
3. Global power economy tracking (power bank availability across shard)

**Implementation effort after E5:** 1-2 days
- Implement power bank decay logic (tick-based countdown)
- Wire into keeper room processor
- Add power bank spawn logic (global spawn timing)
- 5-8 tests covering decay, spawning, and keeper room interactions

---

### 10. Nuker Launch (Cross-Room Coordination)
**Deferred from:** E4 (Simulation Kernel - Room Processor)
**E4 Reference:** `docs/engine/e4.md` ‚Üí "Deferred Features"
**Parity Status:** ‚ö†Ô∏è **LOWER PRIORITY** (advanced structure mechanic)

**Why deferred:**
- Nuker launch creates **cross-room mutations** (damage to target room)
- Launch timing requires **global nuke tracking** (flying nukes in transit)
- Landing logic affects **remote room state** (not local to launching room)
- May be E2 intent handler scope (not passive system), needs verification

**What's needed from E5:**
1. Global nuke tracking (nukes in flight, arrival times)
2. Cross-room mutation infrastructure (damage to remote rooms)
3. Target room notification (alert room owner of incoming nuke)

**Implementation effort after E5:** 1-2 days (if E2 intent handler) OR 2-3 days (if E5 global system)
- Implement nuker launch intent handler (E2 scope: launch validation, cooldown, resource consumption)
- Implement nuke flight tracking (E5 scope: global state for nukes in transit)
- Implement nuke landing logic (E5 scope: apply damage to target room)
- 8-10 tests covering launch, flight, landing, and cross-room effects

**Note:** After E5 Phase 1 (global mutations), verify whether nuker launch is:
- **E2 scope:** Intent handler that queues a global nuke (1-2 hours implementation)
- **E5 scope:** Complex global system with flight tracking and landing logic (2-3 days implementation)

---

## E5 Deliverables (When Implemented)

### 1. Global Mutation Infrastructure
**Analogous to:** `IRoomMutationWriter` (room-level mutations)

**Interface:**
```csharp
public interface IGlobalMutationWriter
{
    // User stats
    void IncrementUserGcl(string userId, int amount);
    void IncrementUserPower(string userId, int amount);  // For power spawns
    void DecrementUserPower(string userId, int amount);  // For generateOps
    void IncrementUserCredits(string userId, int amount);
    void DecrementUserCredits(string userId, int amount);

    // User resources (for intershard operations)
    void IncrementUserResource(string userId, string resourceType, int amount);
    void DecrementUserResource(string userId, string resourceType, int amount);

    // Flush mutations to storage
    Task FlushAsync(CancellationToken token = default);
}
```

**Wiring:**
- Add `IGlobalMutationWriter` to `RoomProcessorContext` constructor
- Inject into `EngineHost` / `MainLoopGlobalProcessor`
- Flush after all room processors complete

---

### 2. Power Effect Tracking
~~**COMPLETED IN E2.3** (January 21, 2026)~~
**Status:** ‚úÖ **NO LONGER NEEDED** - Implemented in E2.3 as part of Power Abilities work

**What was implemented:**
1. ‚úÖ `PowerEffectDecayStep` - Removes expired effects each tick
2. ‚úÖ `PowerAbilityStep` - Applies power effects to structures
3. ‚úÖ Effect consumption in Lab/PowerSpawn/Factory handlers
4. ‚úÖ 67 tests covering power effect lifecycle

**Lesson learned:** Power effects are room-local state, not global state. They didn't require E5 infrastructure.

---

### 3. Market Operations (Lower Priority)
**Note:** Market infrastructure already exists (`MarketIntentStep`), but global market order matching and NPC order generation are deferred.

---

### 4. NPC Spawns (Deferred from E4)
**Note:** NPC spawn logic (invaders, source keepers) was originally planned for E4 but requires global timers and cross-room coordination.
**Details:** See "E4 Deferred Features" section above (#8: NPC Spawning)

---

## Implementation Priority (When Starting E5)

### Phase 1: Global Mutations (Unblocks E2.3) ‚úÖ HIGH PRIORITY
**Effort:** 2-3 days
**Unblocks:** 4 E2.3 features (#1, #2, #6, #7)

1. Implement `IGlobalMutationWriter` interface
2. Add global mutation batching (similar to `BulkRoomMutationWriter`)
3. Wire into `RoomProcessorContext`
4. Add tests for GCL/power balance accumulation
5. **Go back to E2.3:** Implement blocked features:
   - User GCL updates (controller upgrades)
   - Boost effects GCL component
   - PWR_GENERATE_OPS ability
   - User power balance updates (power spawns)

**Estimated E2.3 unblocking time:** 2-3 hours (after E5 Phase 1 complete)

---

### Phase 2: Power Effect Tracking ‚úÖ COMPLETE (E2.3)
~~**Effort:** 1-2 days~~
**Status:** ‚úÖ **NO LONGER NEEDED** - Completed in E2.3 as part of Power Abilities work

**What was implemented:**
- ‚úÖ `PowerEffectDecayStep` - Removes expired effects each tick
- ‚úÖ `PowerAbilityStep` - Applies power effects to structures
- ‚úÖ Effect consumption in Lab/PowerSpawn/Factory handlers
- ‚úÖ 67 tests covering power effect lifecycle

---

### Phase 3: NPC Spawns & Keeper Rooms (Deferred from E4) ‚ö†Ô∏è MEDIUM PRIORITY
**Effort:** 4-7 days
**Unblocks:** 2 E4 features (#8, #9)

1. Implement global room status tracking
2. Add NPC spawn timers (invaders, source keepers)
3. Implement power bank spawn/decay logic
4. Add cross-room NPC coordination
5. 15-20 tests covering NPC spawning, keeper rooms, and power banks

**Dependencies:** E5 Phase 1 (global mutations for power economy)

---

### Phase 4: Nuker Launch & Cross-Room Effects üìã LOWER PRIORITY
**Effort:** 2-3 days
**Unblocks:** 1 E4 feature (#10)

1. Verify scope (E2 intent handler vs E5 global system)
2. Implement nuke flight tracking (if E5 scope)
3. Implement cross-room landing logic
4. 8-10 tests covering launch, flight, and landing

**Dependencies:** E5 Phase 1 (global mutations for cross-room effects)

---

### Phase 5: Market & Shard Messaging üìã LOWEST PRIORITY
**Effort:** 3-5 days
**Unblocks:** Nothing in E2/E4 (market/messaging are independent features)

---

## Cross-References

**Master Roadmap:** `docs/engine/roadmap.md` ‚Üí "E5: Global Systems"
- E5 roadmap entry with status, exit criteria, dependencies

**E2 Plan:** `docs/engine/e2.md`
- See "Controller Intents (Deferred - PARITY-BLOCKING)" for GCL details (#1, #2)
- See "Power Creep Abilities (Deferred)" for PWR_GENERATE_OPS details (#6)
- See "Structure Energy Routing (Deferred Features)" for power balance details (#7)
- See "Deferred Features - Complexity Ranking" for effort estimates

**E4 Plan:** `docs/engine/e4.md`
- See "Deferred Features" section for NPC spawning (#8), power banks (#9), nuker launch (#10)

**Driver CLAUDE.md:** `src/ScreepsDotNet.Driver/CLAUDE.md`
- Global mutations may require driver-level bulk writers (similar to D5)

---

## Success Criteria (When E5 is Complete)

### Phase 1 (High Priority):
1. ‚úÖ `IGlobalMutationWriter` implemented and wired into processor context
2. ‚úÖ User GCL updates work (controller upgrades accumulate GCL)
3. ‚úÖ Boost effects apply to GCL gains (boosted upgrades give more GCL)
4. ‚úÖ User power balance tracking (power spawns increment, generateOps decrements)
5. ‚úÖ PWR_GENERATE_OPS ability functional (power creeps generate ops from balance)
6. ‚úÖ All 4 E2.3 blocked features unblocked and implemented
7. ‚úÖ Tests pass for global mutations (GCL, power balance)

### Phase 2 (Complete):
1. ‚úÖ Power effect decay logic implemented (E2.3)
2. ‚úÖ PWR_OPERATE_LAB boosts lab reaction amounts (E2.3)
3. ‚úÖ PWR_OPERATE_POWER boosts power spawn processing (E2.3)
4. ‚úÖ PWR_OPERATE_FACTORY boosts factory level (E2.3)

### Phase 3 (Medium Priority):
1. ‚úÖ NPC spawning logic (invaders, source keepers)
2. ‚úÖ Power bank spawn/decay mechanics
3. ‚úÖ Keeper room coordination
4. ‚úÖ Tests pass for NPC spawns and keeper rooms

### Phase 4 (Lower Priority):
1. ‚úÖ Nuker launch intent handler (or global system, TBD)
2. ‚úÖ Nuke flight tracking (if E5 scope)
3. ‚úÖ Cross-room landing logic
4. ‚úÖ Tests pass for nuker mechanics

### Phase 5 (Lowest Priority):
1. ‚úÖ Market order matching (global)
2. ‚úÖ NPC market orders
3. ‚úÖ Shard messaging infrastructure

---

**Last Updated:** January 21, 2026
**Status:** Not Started (E4 complete, E5 Phase 1 unblocks 4 E2.3 features)
