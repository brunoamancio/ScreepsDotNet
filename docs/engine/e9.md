# E9 â€“ NPC AI Logic

**Status:** âœ… Phase 1 Complete (Keeper AI) | ðŸŸ¡ Phase 2 Deferred (Invader AI)

**Purpose:** Implement AI behavior for NPC creeps (source keepers, invaders) to achieve full Node.js parity. NPCs spawn correctly (E5) but stand idle without AI.

---

## Dependencies

- âœ… E5 Phase 3: Keeper lair spawning
- âœ… E6: Engine loop orchestration
- âœ… E7: Parity validation framework (Phases 1-5 complete, 7 parity tests operational)
- âœ… E8: Observability

---

## Scope & Status

### Phase 1: Keeper AI - âœ… COMPLETE (2026-01-22)
- âœ… Memory field support (`memory_sourceId`, `memory_move`)
- âœ… Path caching and reuse logic (50-tick cache)
- âœ… Target assignment (source/mineral within 5 tiles)
- âœ… Combat AI (melee + ranged attacks, mass attack threshold)
- âœ… 22 tests passing (12 unit + 10 integration)

### Phase 2: Invader AI - ðŸŸ¡ DEFERRED
- ðŸ“‹ Basic invader movement patterns (patrol, attack)
- ðŸ“‹ Target selection (different from keepers)
- **Reason:** Focus on keeper AI first, invader AI can be added when needed for parity
- **Tracking:** Will be scheduled based on E7 parity requirements

---

## Completion Summary

### Phase 1: Keeper AI - âœ… COMPLETED (2026-01-22)

**Actual Effort:** ~5 hours (matched estimate)

**Deliverables:**
1. âœ… Memory fields added (`MemorySourceId`, `MemoryMove`) with MongoDB mapping
2. âœ… Path caching utilities (`PathCaching` helper class, Node.js-compatible position packing)
3. âœ… `KeeperAiStep` processor with target assignment, movement, and combat logic
4. âœ… 12 unit tests + 10 integration tests (all passing)
5. âœ… Full test suite: 899 tests passing (no regressions)

**Key Files:**
- `ScreepsDotNet.Engine/Processors/Steps/KeeperAiStep.cs` (268 lines)
- `ScreepsDotNet.Engine/Processors/Helpers/PathCaching.cs` (position packing, distance)
- `ScreepsDotNet.Engine.Tests/Processors/Steps/KeeperAiStepTests.cs` (12 unit tests)
- `ScreepsDotNet.Engine.Tests/Processors/Steps/KeeperAiIntegrationTests.cs` (10 integration tests, 450+ lines)

---

## Implementation Deviations

### Direct Mutation vs. Intent Generation
- **Original Plan:** AI generates intents, runs through validation pipeline
- **Implemented:** AI directly applies mutations (patches) to room state
- **Rationale:**
  - Simpler implementation (no intent injection mechanism needed)
  - Better performance (no validation overhead for NPC actions)
  - Cleaner separation (NPCs don't use the same pipeline as players)
- **Impact:** None - behavior is identical, just different internal mechanism

### Simplified Pathfinding
- **Original Plan:** Use `IPathfinderService` for obstacle navigation
- **Implemented:** Simple direct movement calculation (straight line toward target)
- **Rationale:**
  - Keepers spawn near sources and have short patrol ranges
  - Pathfinder would add complexity without significant benefit
  - **TODO in code:** Can be integrated later if needed for complex obstacle navigation
- **Impact:** Keepers may not navigate around obstacles optimally, but this matches most Node.js keeper behavior

---

## Deferred Features

### Phase 2: Invader AI
- **Status:** Not implemented
- **Reason:** Focus on keeper AI first, invader AI can be added when needed for parity
- **Node.js Reference:** `/ScreepsNodeJs/engine/src/processor/intents/creeps/invaders/pretick.js`
- **Scope:**
  - Basic invader movement patterns (patrol, attack)
  - Target selection (different from keepers - attacks controllers, structures)
  - Similar memory/path caching infrastructure
- **Tracking:** Will be scheduled based on E7 parity requirements

### Parity Tests (E7)
- **Status:** Unit and integration tests complete, parity tests deferred to E7
- **Reason:** E7 parity validation framework will test keeper AI against Node.js fixtures
- **Success Criteria:** Keeper behavior matches Node.js fixtures (same room state â†’ same actions)

---

## Possible Optimizations

### 1. Pathfinder Integration
- **Current:** Simple direct movement (straight line)
- **Optimization:** Integrate `IPathfinderService` for optimal obstacle navigation
- **Benefit:** Keepers navigate around walls/ramparts more intelligently
- **Effort:** 1-2 hours (uncomment TODO in code, wire pathfinder service)
- **Priority:** Low (current behavior sufficient for most scenarios)

### 2. Advanced Combat Tactics
- **Current:** Attacks lowest HP target in range
- **Optimization:** Consider target threat level, healing priorities, multi-creep coordination
- **Benefit:** More intelligent keeper defense against organized attacks
- **Effort:** 3-5 hours
- **Priority:** Low (current behavior matches Node.js)

### 3. Dynamic Path Cache Expiration
- **Current:** Fixed 50-tick path reuse
- **Optimization:** Adjust cache expiration based on room congestion, failed moves
- **Benefit:** Better performance in high-traffic rooms
- **Effort:** 1 hour
- **Priority:** Low (50-tick cache is Node.js parity)

---

## Legacy Parity Notes

**Node.js Reference:** `/ScreepsNodeJs/engine/src/processor/intents/creeps/keepers/pretick.js`

**Constants (exact Node.js parity):**
```csharp
// Attack range thresholds
private const int MeleeRange = 1;
private const int RangedRange = 3;

// Ranged attack damage by distance
private static readonly int[] DamageByRange = [10, 10, 4, 1];  // [range 0, 1, 2, 3]

// Mass attack threshold
private const int MassAttackThreshold = 13;  // Use mass attack if total damage > 13

// Path reuse time
private const int PathReuseTime = 50;  // ticks

// Target assignment range
private const int MaxTargetDistance = 5;  // tiles from keeper to source/mineral
```

**Position Packing Format:**
```csharp
// 6 bits for X, 6 bits for Y â†’ single char (offset 32)
public static string PackPosition(int x, int y)
{
    var packed = 0;
    packed <<= 6; packed |= x;
    packed <<= 6; packed |= y;
    var result = char.ConvertFromUtf32(32 + packed);
    return result;
}
```

**Behavior Parity:**
1. âœ… Target selection: Find source/mineral within 5 tiles, store in `memory_sourceId`
2. âœ… Path reuse: Cache path for 50 ticks
3. âœ… Attack priority: Melee target = lowest HP, ranged = mass attack if total damage > 13
4. âœ… Ignore invaders: Only attack player creeps (user ID != "2")
5. âœ… Multi-action: Can move and attack in same tick

---

## Success Criteria

### Phase 1 (Keeper AI) - âœ… ALL COMPLETE
1. âœ… Memory fields added to `RoomObjectSnapshot` and `RoomObjectPatchPayload`
2. âœ… `KeeperAiStep` implemented and registered in processor pipeline
3. âœ… Path caching/reuse logic functional
4. âœ… 12 unit tests passing (target selection, movement, attack logic)
5. âœ… 10 integration tests passing (full lifecycle, combat, path caching across ticks)
6. ðŸŸ¡ Parity test deferred (will be part of E7 validation)
7. âœ… Keepers defend keeper rooms against player intrusion (behavior verified via unit and integration tests)

### Phase 2 (Invader AI) - ðŸŸ¡ DEFERRED
- All criteria deferred to future milestone

---

## Cross-References

**Roadmap:** `docs/engine/roadmap.md` â†’ E9 entry
**E5 Plan:** `docs/engine/e5.md` â†’ Phase 3 (keeper spawning)
**E7 Plan:** `docs/engine/e7.md` â†’ Parity validation infrastructure (Phases 1-5 complete)
**Pathfinder Docs:** `docs/driver/d6-pathfinder.md`
**Node.js Source:** `/ScreepsNodeJs/engine/src/processor/intents/creeps/keepers/pretick.js`

---

**Last Updated:** 2026-01-22
