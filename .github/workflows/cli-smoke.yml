name: CLI Smoke Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      native: ${{ steps.filter.outputs.native }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.event.pull_request.base.sha || github.event.before || 'HEAD^' }}
          filters: |
            native:
              - 'src/native/pathfinder/**'
              - 'src/ScreepsDotNet.Driver/**'

  build-native:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.native == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Build native pathfinder (linux-x64)
        run: |
          set -euo pipefail
          ./src/native/pathfinder/build.sh linux-x64

      - name: Upload native linux-x64 artifact
        uses: actions/upload-artifact@v6
        with:
          name: native-linux-x64
          path: src/ScreepsDotNet.Driver/runtimes/linux-x64/native

  cli-smoke:
    needs: [changes, build-native]
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download native linux-x64 artifact
        if: needs.build-native.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: native-linux-x64
          path: native-artifacts/linux-x64

      - name: Install native linux-x64 artifact
        if: needs.build-native.result == 'success'
        run: |
          set -euo pipefail
          rm -rf src/ScreepsDotNet.Driver/runtimes/linux-x64/native
          mkdir -p src/ScreepsDotNet.Driver/runtimes/linux-x64/native
          cp -R native-artifacts/linux-x64/. src/ScreepsDotNet.Driver/runtimes/linux-x64/native/

      - name: Start Docker service
        run: |
          sudo systemctl start docker
          docker info

      - name: Launch Mongo + Redis
        run: docker compose -f src/docker-compose.yml up -d

      - name: Wait for Mongo + Redis to initialize
        run: sleep 15

      - name: Cache NuGet packages
        uses: actions/cache@v5.0.2
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('src/**/*.csproj', 'src/Directory.Build.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore solution
        run: dotnet restore src/ScreepsDotNet.slnx

      - name: Run unit and integration tests
        run: dotnet test src/ScreepsDotNet.slnx --nologo

      - name: CLI smoke - storage status
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- storage status --json

      - name: CLI smoke - world stats
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- world stats --room W1N1 --stat owners1 --json

      - name: CLI smoke - world dump
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- world dump --room W1N1 --decoded --json

      - name: CLI smoke - bots list
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- bots list --json

      - name: CLI smoke - user show
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- user show --username test-user --format markdown

      - name: CLI smoke - auth token list
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- auth token-list --json

      - name: CLI smoke - system status
        run: dotnet run --project src/ScreepsDotNet.Backend.Cli/ScreepsDotNet.Backend.Cli.csproj -- system status --json
