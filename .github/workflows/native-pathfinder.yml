name: Native Pathfinder Build

on:
  push:
    branches: [ main ]
    paths:
      - "native/pathfinder/**"
      - ".github/workflows/native-pathfinder.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "native/pathfinder/**"
      - ".github/workflows/native-pathfinder.yml"
  workflow_dispatch:

jobs:
  build-native:
    name: Build on ${{ matrix.os }} (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            disabled: false
          - os: ubuntu-latest
            rid: linux-arm64
            disabled: true
          - os: windows-latest
            rid: win-x64
            vcvars: x64
            disabled: true
          - os: windows-latest
            rid: win-arm64
            vcvars: x64_arm64
            disabled: true
          - os: macos-latest
            rid: osx-x64
            disabled: true
          - os: macos-14
            rid: osx-arm64
            disabled: true

    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine working directory
        if: ${{ matrix.disabled != true }}
        run: |
          if [ -d "native/pathfinder" ]; then
            echo "workdir=native/pathfinder" >> $GITHUB_ENV
          elif [ -d "ScreepsDotNet/native/pathfinder" ]; then
            echo "workdir=ScreepsDotNet/native/pathfinder" >> $GITHUB_ENV
          else
            echo "Native pathfinder directory not found" >&2
            exit 1
          fi
        shell: bash

      - name: Show working directory
        if: ${{ matrix.disabled != true }}
        run: echo "Using workdir ${{ env.workdir }}"

      - name: Show CMake version
        if: ${{ matrix.disabled != true }}
        run: |
          cd "${{ env.workdir }}"
          cmake --version

      - name: Skip job
        if: matrix.disabled == true
        run: echo "Skipping ${matrix.rid}"

      - name: Install cross toolchain
        if: matrix.disabled != true && runner.os == 'Linux' && matrix.rid == 'linux-arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build libscreepspathfinder (Windows)
        if: matrix.disabled != true && runner.os == 'Windows'
        shell: pwsh
        env:
          RID: ${{ matrix.rid }}
          VCVARS: ${{ matrix.vcvars }}
        run: |
          if (-not $Env:VCVARS) { $Env:VCVARS = "x64" }
          $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) { throw "vswhere.exe not found at $vswhere" }
          $vsPath = & $vswhere -latest -prerelease -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $vsPath) { throw "Unable to locate Visual Studio installation via vswhere.exe" }
          $vcvarsPath = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
          if (-not (Test-Path $vcvarsPath)) { throw "vcvarsall.bat not found at $vcvarsPath" }
          & cmd.exe /c "`"$vcvarsPath`" $Env:VCVARS && cd ${{ env.workdir }} && bash ./build.sh $Env:RID"

      - name: Build libscreepspathfinder (POSIX)
        if: matrix.disabled != true && runner.os != 'Windows'
        shell: bash
        run: |
          cd "${{ env.workdir }}"
          ./build.sh "${{ matrix.rid }}"

      - name: Package native artifact (POSIX)
        if: matrix.disabled != true && runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.workdir }}"
          dist_dir="$(pwd)/dist"
          native_dir="../../ScreepsDotNet.Driver/runtimes/${{ matrix.rid }}/native"
          if [[ ! -d "$native_dir" ]]; then
            echo "Native pathfinder output not found at $native_dir" >&2
            exit 1
          fi
          mkdir -p "$dist_dir"
          zip_path="$dist_dir/native-pathfinder-${{ matrix.rid }}.zip"
          rm -f "$zip_path"
          (cd "$native_dir" && zip -r "$zip_path" .)

      - name: Package native artifact (Windows)
        if: matrix.disabled != true && runner.os == 'Windows'
        shell: pwsh
        run: |
          Push-Location "${{ env.workdir }}"
          $dist = Join-Path (Get-Location) "dist"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          $dest = Join-Path $dist "native-pathfinder-${{ matrix.rid }}.zip"
          if (Test-Path $dest) { Remove-Item $dest }
          $nativePath = Join-Path "..\..\ScreepsDotNet.Driver\runtimes\${{ matrix.rid }}" "native"
          if (-not (Test-Path $nativePath)) {
            Write-Error "Native pathfinder output not found at $nativePath"
            exit 1
          }
          Compress-Archive -Path "$nativePath\*" -DestinationPath $dest -Force
          Pop-Location

      - name: Upload native artifact
        uses: actions/upload-artifact@v6
        with:
          name: native-pathfinder-${{ matrix.rid }}
          path: ${{ env.workdir }}/dist/native-pathfinder-${{ matrix.rid }}.zip
        if: matrix.disabled != true

  release-native:
    name: Publish native release
    needs: build-native
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: native-artifacts

      - name: List artifacts
        run: ls -R native-artifacts

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: native-latest
          name: Native Pathfinder (latest)
          prerelease: true
          draft: false
          files: native-artifacts/**/native-pathfinder-*.zip
          make_latest: true
          body: "Automated native pathfinder binaries built from ${{ github.sha }}."
          allow_updates: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
