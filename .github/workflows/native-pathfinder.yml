name: Native Pathfinder Build

on:
  push:
    branches: [ main ]
    paths:
      - "src/native/pathfinder/**"
      - ".github/workflows/native-pathfinder.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "src/native/pathfinder/**"
      - ".github/workflows/native-pathfinder.yml"
  workflow_dispatch:

jobs:
  build-native:
    name: Build on ${{ matrix.os }} (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            disabled: false
          - os: ubuntu-latest
            rid: linux-arm64
            disabled: false
          - os: ubuntu-latest
            rid: linux-x86
            disabled: false
          - os: windows-latest
            rid: win-x64
            vcvars: x64
            disabled: false
          - os: windows-latest
            rid: win-x86
            vcvars: x86
            disabled: false
          - os: windows-latest
            rid: win-arm64
            vcvars: x64_arm64
            disabled: false
          - os: macos-latest
            rid: osx-x64
            disabled: false
          - os: macos-14
            rid: osx-arm64
            disabled: false

    steps:

      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine working directory
        if: ${{ matrix.disabled != true }}
        run: |
          if [ -d "src/native/pathfinder" ]; then
            echo "workdir=src/native/pathfinder" >> $GITHUB_ENV
            echo "driver_dir=$GITHUB_WORKSPACE/src/ScreepsDotNet.Driver" >> $GITHUB_ENV
          elif [ -d "native/pathfinder" ]; then
            echo "workdir=native/pathfinder" >> $GITHUB_ENV
            echo "driver_dir=$GITHUB_WORKSPACE/ScreepsDotNet.Driver" >> $GITHUB_ENV
          elif [ -d "ScreepsDotNet/native/pathfinder" ]; then
            echo "workdir=ScreepsDotNet/native/pathfinder" >> $GITHUB_ENV
            echo "driver_dir=$GITHUB_WORKSPACE/ScreepsDotNet/ScreepsDotNet.Driver" >> $GITHUB_ENV
          else
            echo "Native pathfinder directory not found" >&2
            exit 1
          fi
        shell: bash

      - name: Show working directory
        if: ${{ matrix.disabled != true }}
        run: echo "Using workdir ${{ env.workdir }}"

      - name: Show CMake version
        if: ${{ matrix.disabled != true }}
        run: |
          cd "${{ env.workdir }}"
          cmake --version

      - name: Skip job (POSIX)
        if: matrix.disabled == true && runner.os != 'Windows'
        shell: bash
        run: echo "Skipping ${{ matrix.rid }}"

      - name: Skip job (Windows)
        if: matrix.disabled == true && runner.os == 'Windows'
        shell: pwsh
        run: Write-Host "Skipping ${{ matrix.rid }}"

      - name: Install cross toolchain
        if: matrix.disabled != true && runner.os == 'Linux' && (matrix.rid == 'linux-arm64' || matrix.rid == 'linux-x86')
        run: |
          sudo apt-get update
          if [ "${{ matrix.rid }}" = "linux-arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          else
            sudo apt-get install -y g++-multilib
          fi

      - name: Build libscreepspathfinder (Windows)
        if: matrix.disabled != true && runner.os == 'Windows'
        shell: pwsh
        env:
          RID: ${{ matrix.rid }}
          VCVARS: ${{ matrix.vcvars }}
        run: |
          if (-not $Env:VCVARS) { $Env:VCVARS = "x64" }
          $vswhere = "${Env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
          if (-not (Test-Path $vswhere)) { throw "vswhere.exe not found at $vswhere" }
          $vsPath = & $vswhere -latest -prerelease -requires Microsoft.Component.MSBuild -property installationPath
          if (-not $vsPath) { throw "Unable to locate Visual Studio installation via vswhere.exe" }
          $vcvarsPath = Join-Path $vsPath "VC\Auxiliary\Build\vcvarsall.bat"
          if (-not (Test-Path $vcvarsPath)) { throw "vcvarsall.bat not found at $vcvarsPath" }
          & cmd.exe /c "`"$vcvarsPath`" $Env:VCVARS && cd ${{ env.workdir }} && bash ./build.sh $Env:RID"

      - name: Build libscreepspathfinder (POSIX)
        if: matrix.disabled != true && runner.os != 'Windows'
        shell: bash
        run: |
          cd "${{ env.workdir }}"
          ./build.sh "${{ matrix.rid }}"

      - name: Package native artifact (POSIX)
        if: matrix.disabled != true && runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          cd "${{ env.workdir }}"
          dist_dir="$(pwd)/dist"
          native_dir="${{ env.driver_dir }}/runtimes/${{ matrix.rid }}/native"
          if [[ ! -d "$native_dir" ]]; then
            echo "Native pathfinder output not found at $native_dir" >&2
            exit 1
          fi
          mkdir -p "$dist_dir"
          zip_path="$dist_dir/native-pathfinder-${{ matrix.rid }}.zip"
          rm -f "$zip_path"
          (cd "$native_dir" && zip -r "$zip_path" .)
          shasum -a 256 "$zip_path" > "${zip_path}.sha256"

      - name: Package native artifact (Windows)
        if: matrix.disabled != true && runner.os == 'Windows'
        shell: pwsh
        run: |
          Push-Location "${{ env.workdir }}"
          $dist = Join-Path (Get-Location) "dist"
          New-Item -ItemType Directory -Force -Path $dist | Out-Null
          $dest = Join-Path $dist "native-pathfinder-${{ matrix.rid }}.zip"
          if (Test-Path $dest) { Remove-Item $dest }
          $nativePath = Join-Path "${{ env.driver_dir }}" "runtimes\${{ matrix.rid }}\native"
          if (-not (Test-Path $nativePath)) {
            Write-Error "Native pathfinder output not found at $nativePath"
            exit 1
          }
          Compress-Archive -Path "$nativePath\*" -DestinationPath $dest -Force
          $hash = Get-FileHash -Path $dest -Algorithm SHA256
          "$($hash.Hash)  $(Split-Path -Leaf $dest)" | Out-File -FilePath "$dest.sha256" -Encoding ascii
          Pop-Location

      - name: Upload native artifact
        uses: actions/upload-artifact@v6
        with:
          name: native-pathfinder-${{ matrix.rid }}
          path: |
            ${{ env.workdir }}/dist/native-pathfinder-${{ matrix.rid }}.zip
            ${{ env.workdir }}/dist/native-pathfinder-${{ matrix.rid }}.zip.sha256
        if: matrix.disabled != true

  release-native:
    name: Publish native release
    needs: build-native
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: native-artifacts

      - name: List artifacts
        run: ls -R native-artifacts

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2.5.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: native-pathfinder-latest
          name: Native Pathfinder (latest)
          prerelease: true
          draft: false
          files: |
            native-artifacts/**/native-pathfinder-*.zip
            native-artifacts/**/native-pathfinder-*.zip.sha256
          make_latest: true
          overwrite_files: true
          body: "Automated native pathfinder binaries built from ${{ github.sha }}."
